
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mkdox curlpipebash by pforret">
      
      
      
        <link rel="canonical" href="https://curlpipebash.com/examples/install.sandstorm.io.69/">
      
      
        <link rel="prev" href="../get.docker.com.ff/">
      
      
        <link rel="next" href="../laravel.build.ce/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../icon/android-chrome-192x192.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>install.sandstorm.io - curl | bash</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Nunito";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- your analytics script -->
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installsandstormio" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="curl | bash" class="md-header__button md-logo" aria-label="curl | bash" data-md-component="logo">
      
  <img src="../../icon/android-chrome-192x192.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            curl | bash
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              install.sandstorm.io
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  curl | bash

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
  About

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../frankenphp.dev.5a/" class="md-tabs__link">
          
  
  Examples

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="curl | bash" class="md-nav__button md-logo" aria-label="curl | bash" data-md-component="logo">
      
  <img src="../../icon/android-chrome-192x192.png" alt="logo">

    </a>
    curl | bash
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    curl | bash
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About this site
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    News
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2026/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2026
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../frankenphp.dev.5a/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frankenphp.dev/install.sh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get.docker.com.ff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get.docker.com
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    install.sandstorm.io
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    install.sandstorm.io
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#description" class="md-nav__link">
    <span class="md-ellipsis">
      Description
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stats" class="md-nav__link">
    <span class="md-ellipsis">
      Stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    <span class="md-ellipsis">
      Code
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../laravel.build.ce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    laravel.build/example-app
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../php.new.d9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    php.new/install/mac/8.4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../raw.githubusercontent.com.0c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /basherpm/basher/master/install.sh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../raw.githubusercontent.com.a3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /Homebrew/install/HEAD/install.sh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../raw.githubusercontent.com.fb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /nvm-sh/nvm/v0.40.1/install.sh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sdk.cloud.google.com.5a/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sdk.cloud.google.com
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="installsandstormio">install.sandstorm.io<a class="headerlink" href="#installsandstormio" title="Permanent link">&para;</a></h1>
<h2 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h2>
<ul>
<li>run <code>curl -s https://install.sandstorm.io | bash</code> to install Sandstorm self-hosting platform</li>
<li>cf <a href="https://sandstorm.org/install">https://sandstorm.org/install</a> </li>
</ul>
<h2 id="stats">Stats<a class="headerlink" href="#stats" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
Bourne Shell                     1            285            464           1403
-------------------------------------------------------------------------------
</code></pre></div>
<h2 id="code">Code<a class="headerlink" href="#code" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="ch">#! /bin/bash</span>

<span class="c1"># This script installs the Sandstorm Personal Cloud Server on your Linux</span>
<span class="c1"># machine. You can run the latest installer directly from the web by doing:</span>
<span class="c1">#</span>
<span class="c1">#     curl https://install.sandstorm.io | bash</span>
<span class="c1">#</span>
<span class="c1"># If `curl|bash` makes you uncomfortable, see other options here:</span>
<span class="c1">#</span>
<span class="c1">#     https://docs.sandstorm.io/en/latest/install/</span>
<span class="c1">#</span>
<span class="c1"># This script only modifies your system in the following ways:</span>
<span class="c1"># - Install Sandstorm into the directory you choose, typically /opt/sandstorm.</span>
<span class="c1"># - Optionally add an initscript or systemd service:</span>
<span class="c1">#     /etc/init.d/sandstorm</span>
<span class="c1">#     /etc/systemd/system/sandstorm.service</span>
<span class="c1"># - Add commands &quot;sandstorm&quot; and &quot;spk&quot; to /usr/local/bin.</span>
<span class="c1">#</span>
<span class="c1"># Once installed, you may uninstall with the command: sandstorm uninstall</span>
<span class="c1">#</span>
<span class="c1"># The script will ask you whether you&#39;re OK with giving it root privileges.</span>
<span class="c1"># If you refuse, the script can still install Sandstorm (to a directory you</span>
<span class="c1"># own), but will not be able to install the initscript or shortcut commands,</span>
<span class="c1"># and the dev tools will not work (due to limitations with using FUSE in a</span>
<span class="c1"># sandbox).</span>
<span class="c1">#</span>
<span class="c1"># This script downloads and installs binaries. This means that to use this</span>
<span class="c1"># script, you need to trust that the authors are not evil, or you must use</span>
<span class="c1"># an isolated machine or VM. Of course, since the Sandstorm authors&#39;</span>
<span class="c1"># identities are widely known, if they did try to do anything evil, you</span>
<span class="c1"># could easily get them arrested. That said, if you&#39;d rather install from</span>
<span class="c1"># 100% auditable source code, please check out the Github repository instead.</span>
<span class="c1">#</span>
<span class="c1"># All downloads occur over HTTPS from Sandstorm&#39;s servers and are further</span>
<span class="c1"># verified using PGP.</span>

<span class="k">if</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BASH_VERSION</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Please run this script using bash, not sh or any other shell.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># We wrap the entire script in a big function which we only call at the very end, in order to</span>
<span class="c1"># protect against the possibility of the connection dying mid-script. This protects us against</span>
<span class="c1"># the problem described in this blog post:</span>
<span class="c1">#   http://blog.existentialize.com/dont-pipe-to-your-shell.html</span>
_<span class="o">()</span><span class="w"> </span><span class="o">{</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># Declare an array so that we can capture the original arguments.</span>
<span class="nb">declare</span><span class="w"> </span>-a<span class="w"> </span>ORIGINAL_ARGS

<span class="c1"># Allow the environment to override curl&#39;s User-Agent parameter. We</span>
<span class="c1"># use this to distinguish probably-actual-users installing Sandstorm</span>
<span class="c1"># from the automated test suite, which invokes the install script with</span>
<span class="c1"># this environment variable set.</span>
<span class="nv">CURL_USER_AGENT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CURL_USER_AGENT</span><span class="k">:-</span><span class="nv">sandstorm</span><span class="p">-install-script</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Define I/O helper functions.</span>
error<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-en<span class="w"> </span><span class="s1">&#39;\e[0;31m&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span>fold<span class="w"> </span>-s<span class="w"> </span><span class="o">||</span><span class="w"> </span>cat<span class="o">)</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-en<span class="w"> </span><span class="s1">&#39;\e[0m&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

fail<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">error_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">shift</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SHOW_FAILURE_MSG</span><span class="k">:-</span><span class="nv">yes</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*** INSTALLATION FAILED ***&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span>error<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$error_code</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>E_CURL_MISSING<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># There&#39;s no point in asking the user if they want to report an issue, since</span>
<span class="w">    </span><span class="c1"># (1) there isn&#39;t one, they just need to install curl, and (2) doing so will</span>
<span class="w">    </span><span class="c1"># fail anyway, since we use curl to send the report. We&#39;ve already displayed</span>
<span class="w">    </span><span class="c1"># the error, so just exit now.</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Users can export REPORT=no to avoid the error-reporting behavior, if they need to.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REPORT</span><span class="k">:-</span><span class="nv">yes</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">USE_DEFAULTS</span><span class="o">=</span>no<span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Hmm, installation failed. Would it be OK to send an anonymous error </span>
<span class="s2">report to the sandstorm.io team so we know something is wrong?</span>
<span class="s2">It would only contain this error code: </span><span class="nv">$error_code</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sending problem report...&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">BEARER_TOKEN</span><span class="o">=</span><span class="s2">&quot;4-Og3Ty2SPmpkZGnVc_8hnBGXK0JBBXDeBn_55FWixJ&quot;</span>
<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">API_ENDPOINT</span><span class="o">=</span><span class="s2">&quot;https://alpha-api-df09d5faefd551337b59659de8ae7207.sandstorm.io&quot;</span>
<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">        </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--data-binary<span class="w"> </span><span class="s2">&quot;{\&quot;error_code\&quot;:\&quot;</span><span class="nv">$error_code</span><span class="s2">\&quot;,\&quot;user-agent\&quot;:\&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">\&quot;}&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$BEARER_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--output<span class="w"> </span><span class="s2">&quot;/dev/null&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="s2">&quot;</span><span class="nv">$API_ENDPOINT</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;... problem reported successfully. Your installation did not succeed.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;000&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Submitting error report failed. Maybe there is a connectivity problem.&quot;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span>error<span class="w"> </span><span class="s2">&quot;Submitting error report resulted in strange HTTP status: </span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Not sending report.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You can report bugs at: http://github.com/sandstorm-io/sandstorm&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

retryable_curl<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># This function calls curl to download a file. If the file download fails, it asks the user if it</span>
<span class="w">  </span><span class="c1"># is OK to retry.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">CURL_FAILED</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span>curl<span class="w"> </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CURL_USER_AGENT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">CURL_FAILED</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CURL_FAILED</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Downloading </span><span class="nv">$1</span><span class="s2"> failed. OK to retry?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Download failed. Waiting one second before retrying...&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">      </span>retryable_curl<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

dotdotdot_curl<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># This function calls curl, but first prints &quot;...&quot; to the screen, in</span>
<span class="w">  </span><span class="c1"># an attempt to indicate to the user that the script is waiting on</span>
<span class="w">  </span><span class="c1"># something.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># It then moves the cursor to the start of the line, so that future</span>
<span class="w">  </span><span class="c1"># echo-ing will overwrite those dots.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># Since the script is -e, and in general we don&#39;t have a reliable</span>
<span class="w">  </span><span class="c1"># thing that we do in the case that curl exits with a non-zero</span>
<span class="w">  </span><span class="c1"># status code, we don&#39;t capture the status code; we allow the script</span>
<span class="w">  </span><span class="c1"># to abort if curl exits with a non-zero status.</span>

<span class="w">  </span><span class="c1"># Functions calling dotdotdot_curl expect to capture curl&#39;s own</span>
<span class="w">  </span><span class="c1"># stdout. Therefore we do our echo-ing to stderr.</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>

<span class="w">  </span>curl<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;\r&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="o">}</span>

is_port_bound<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">SCAN_HOST</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">SCAN_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEV_TCP_USABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;unchecked&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_DEV_TCP_UNCHECKED&quot;</span><span class="w"> </span><span class="s2">&quot;Programmer error. The author of install.sh used an uninitialized </span>
<span class="s2">variable.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># We also use timeout(1) from coreutils to avoid this process taking a very long</span>
<span class="w">  </span><span class="c1"># time in the case of e.g. weird network rules or something.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEV_TCP_USABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;: &lt; /dev/tcp/</span><span class="si">${</span><span class="nv">SCAN_HOST</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SCAN_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we are using a traditional netcat, then -z (zero i/o mode)</span>
<span class="w">  </span><span class="c1"># works for scanning-type uses. (Debian defaults to this.)</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># If we are using the netcat from the nmap package, then we can use</span>
<span class="w">  </span><span class="c1"># --recv-only --send-only to get the same behavior. (Fedora defaults</span>
<span class="w">  </span><span class="c1"># to this.)</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># nc will either:</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># - return true (exit 0) if it connected to the port, or</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># - return false (exit 1) if it failed to connect to the port, or</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># - return false (exit 1) if we are passing it the wrong flags.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># So if either if these invocations returns true, then we know the</span>
<span class="w">  </span><span class="c1"># port is bound.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">DEBIAN_STYLE_INDICATED_BOUND</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="si">${</span><span class="nv">NC_PATH</span><span class="si">}</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCAN_HOST</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCAN_PORT</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">DEBIAN_STYLE_INDICATED_BOUND</span><span class="o">=</span>yes

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEBIAN_STYLE_INDICATED_BOUND</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Not sure yet. Let&#39;s try the nmap-style way.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">NMAP_STYLE_INDICATED_BOUND</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="si">${</span><span class="nv">NC_PATH</span><span class="si">}</span><span class="w"> </span>--wait<span class="w"> </span><span class="m">1</span><span class="w"> </span>--recv-only<span class="w"> </span>--send-only<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCAN_HOST</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCAN_PORT</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">NMAP_STYLE_INDICATED_BOUND</span><span class="o">=</span>yes

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NMAP_STYLE_INDICATED_BOUND</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># As far as we can tell, nmap can&#39;t connect to the port, so return 1</span>
<span class="w">  </span><span class="c1"># to indicate it is not bound.</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

<span class="c1"># writeConfig takes a list of shell variable names and saves them, and</span>
<span class="c1"># their contents, to stdout. Therefore, the caller should redirect its</span>
<span class="c1"># output to a config file.</span>
writeConfig<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">eval</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">=\$</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">shift</span>
<span class="w">  </span><span class="k">done</span>
<span class="o">}</span>

prompt<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span>VALUE

<span class="w">  </span><span class="c1"># Hack: We read from FD 3 because when reading the script from a pipe, FD 0 is the script, not</span>
<span class="w">  </span><span class="c1">#   the terminal. We checked above that FD 1 (stdout) is in fact a terminal and then dup it to</span>
<span class="w">  </span><span class="c1">#   FD 3, thus we can input from FD 3 here.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Print the default.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># We use &quot;bold&quot;, rather than any particular color, to maximize readability. See #2037.</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-en<span class="w"> </span><span class="s1">&#39;\e[1m&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">3</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> [</span><span class="nv">$2</span><span class="s2">]&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">3</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-en<span class="w"> </span><span class="s1">&#39;\e[0m &#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">3</span>
<span class="w">  </span><span class="nb">read</span><span class="w"> </span>-u<span class="w"> </span><span class="m">3</span><span class="w"> </span>VALUE
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VALUE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">VALUE</span><span class="o">=</span><span class="nv">$2</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VALUE</span><span class="s2">&quot;</span>
<span class="o">}</span>

prompt-numeric<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">NUMERIC_REGEX</span><span class="o">=</span><span class="s2">&quot;^[0-9]+</span>$<span class="s2">&quot;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">VALUE</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VALUE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span><span class="nv">$NUMERIC_REGEX</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You entered &#39;</span><span class="nv">$VALUE</span><span class="s2">&#39;. Please enter a number.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">3</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VALUE</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>
<span class="o">}</span>

prompt-yesno<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">VALUE</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nv">$VALUE</span><span class="w"> </span><span class="k">in</span>
<span class="w">      </span>y<span class="w"> </span><span class="p">|</span><span class="w"> </span>Y<span class="w"> </span><span class="p">|</span><span class="w"> </span>yes<span class="w"> </span><span class="p">|</span><span class="w"> </span>YES<span class="w"> </span><span class="p">|</span><span class="w"> </span>Yes<span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>n<span class="w"> </span><span class="p">|</span><span class="w"> </span>N<span class="w"> </span><span class="p">|</span><span class="w"> </span>no<span class="w"> </span><span class="p">|</span><span class="w"> </span>NO<span class="w"> </span><span class="p">|</span><span class="w"> </span>No<span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*** Please answer \&quot;yes\&quot; or \&quot;no\&quot;.&quot;</span>
<span class="w">  </span><span class="k">done</span>
<span class="o">}</span>

<span class="c1"># Define global variables that the install script will use to mark its</span>
<span class="c1"># own progress.</span>

<span class="nv">USE_DEFAULTS</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">USE_SANDCATS</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">SANDCATS_SUCCESSFUL</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">USE_HTTPS</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">CURRENTLY_UID_ZERO</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">PREFER_ROOT</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="nv">SHOW_MESSAGE_ABOUT_NEEDING_PORTS_OPEN</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="nv">STARTED_SANDSTORM</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>

<span class="c1"># Allow the test suite to override the path to netcat in order to</span>
<span class="c1"># reproduce a compatibility issue between different nc versions.</span>
<span class="nv">NC_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_NC_PATH</span><span class="k">:-</span><span class="nv">nc</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Allow install.sh to store if bash /dev/tcp works.</span>
<span class="nv">DEV_TCP_USABLE</span><span class="o">=</span><span class="s2">&quot;unchecked&quot;</span>

<span class="c1"># Defaults for some config options, so that if the user requests no</span>
<span class="c1"># prompting, they get these values.</span>
<span class="nv">DEFAULT_DIR_FOR_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDSTORM_DEFAULT_DIR</span><span class="k">:-</span><span class="p">/opt/sandstorm</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">DEFAULT_DIR_FOR_NON_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDSTORM_DEFAULT_DIR</span><span class="k">:-</span><span class="si">${</span><span class="nv">HOME</span><span class="k">:-</span><span class="nv">opt</span><span class="si">}</span><span class="p">/sandstorm</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">DEFAULT_SMTP_PORT</span><span class="o">=</span><span class="s2">&quot;30025&quot;</span>
<span class="nv">DEFAULT_UPDATE_CHANNEL</span><span class="o">=</span><span class="s2">&quot;dev&quot;</span>
<span class="nv">DEFAULT_SERVER_USER</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDSTORM_DEFAULT_SERVER_USER</span><span class="k">:-</span><span class="nv">sandstorm</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">SANDCATS_BASE_DOMAIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_BASE_DOMAIN</span><span class="k">:-</span><span class="nv">sandcats</span><span class="p">.io</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>

<span class="c1"># Define functions for each stage of the install process.</span>

usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;usage: </span><span class="nv">$SCRIPT_NAME</span><span class="s2"> [-d] [-e] [-p PORT_NUMBER] [-u] [&lt;bundle&gt;]&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;If &lt;bundle&gt; is provided, it must be the name of a Sandstorm bundle file,&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;like &#39;sandstorm-123.tar.xz&#39;, which will be installed. Otherwise, the script&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;downloads a bundle from the internet via HTTPS.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;If -d is specified, the auto-installs with defaults suitable for app development.&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;If -e is specified, default to listening on an external interface, not merely loopback.&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;If -i is specified, default to (i)nsecure mode where we do not request a HTTPS certificate.&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;If -p is specified, use its argument (PORT_NUMBER) as the default port for HTTP. Otherwise, use 6080. </span>
<span class="s1">Note that if the install script enables HTTPS, it will use 443 instead!&#39;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;If -u is specified, default to avoiding root priviliges. Note that the dev tools only work if the </span>
<span class="s1">server has root privileges.&#39;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

detect_current_uid<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">CURRENTLY_UID_ZERO</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

disable_smtp_port_25_if_port_unavailable<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">PORT_25_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>is_port_bound<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="m">25</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>is_port_bound<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="m">25</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nv">PORT_25_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="o">}</span>

check_if_ports_unavailable<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">PORT_80_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span>is_port_bound<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">PORT_80_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">PORT_443_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span>is_port_bound<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="m">443</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">PORT_443_AVAILABLE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT_443_AVAILABLE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT_80_AVAILABLE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">SHOW_MESSAGE_ABOUT_NEEDING_PORTS_OPEN</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>


handle_args<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">SCRIPT_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">  </span><span class="nb">shift</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="nb">getopts</span><span class="w"> </span><span class="s2">&quot;:deiup:&quot;</span><span class="w"> </span>opt<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nv">$opt</span><span class="w"> </span><span class="k">in</span>
<span class="w">      </span>d<span class="o">)</span>
<span class="w">        </span><span class="nv">USE_DEFAULTS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>e<span class="o">)</span>
<span class="w">        </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>i<span class="o">)</span>
<span class="w">        </span><span class="c1"># TODO(soon): Fix or remove this option, which currently does nothing</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>u<span class="o">)</span>
<span class="w">        </span><span class="nv">PREFER_ROOT</span><span class="o">=</span>no
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>p<span class="o">)</span>
<span class="w">        </span><span class="nv">DEFAULT_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPTARG</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">      </span>*<span class="o">)</span>
<span class="w">        </span>usage
<span class="w">        </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="w">  </span><span class="k">done</span>

<span class="w">  </span><span class="c1"># If DEFAULT_PORT didn&#39;t get set above, set it to 6080 here.</span>
<span class="w">  </span><span class="nv">DEFAULT_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_PORT</span><span class="k">:-</span><span class="nv">6080</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="c1"># Keep a copy of the ORIGINAL_ARGS so that, when re-execing ourself,</span>
<span class="w">  </span><span class="c1"># we can pass them in.</span>
<span class="w">  </span><span class="nv">ORIGINAL_ARGS</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="w">  </span><span class="c1"># Pass positional parameters through</span>
<span class="w">  </span><span class="nb">shift</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$((</span><span class="nv">OPTIND</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^-<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">BUNDLE_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>usage
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

rerun_script_as_root<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Note: This function assumes that the caller has requested</span>
<span class="w">  </span><span class="c1"># permission to use sudo!</span>

<span class="w">  </span><span class="c1"># Pass $@ here to enable the caller to provide environment</span>
<span class="w">  </span><span class="c1"># variables to bash, which will affect the execution plan of</span>
<span class="w">  </span><span class="c1"># the resulting install script run.</span>

<span class="w">  </span><span class="c1"># Remove newlines in $@, otherwise when we try to use $@ in a string passed</span>
<span class="w">  </span><span class="c1"># to &#39;bash -c&#39; the command gets cut off at the newline. ($@ contains newlines</span>
<span class="w">  </span><span class="c1"># because at the call site we used escaped newlines for readability.)</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">ENVVARS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$@</span><span class="k">)</span>

<span class="w">  </span><span class="c1"># Add CURL_USER_AGENT to ENVVARS, since we always need to pass this</span>
<span class="w">  </span><span class="c1"># through.</span>
<span class="w">  </span><span class="nv">ENVVARS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ENVVARS</span><span class="s2"> CURL_USER_AGENT=</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$SCRIPT_NAME</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>bash<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Probably ran like &quot;curl https://sandstorm.io/install.sh | bash&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Re-running script as root...&quot;</span>

<span class="w">    </span><span class="nb">exec</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span>-euo<span class="w"> </span>pipefail<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;curl -fs -A </span><span class="nv">$CURL_USER_AGENT</span><span class="s2"> https://install.sandstorm.io | </span><span class="nv">$ENVVARS</span><span class="s2"> </span>
<span class="s2">bash&quot;</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$SCRIPT_NAME</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>install.sh<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Probably ran like &quot;bash install.sh&quot; or &quot;./install.sh&quot;.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Re-running script as root...&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="si">${#</span><span class="nv">ORIGINAL_ARGS</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">exec</span><span class="w"> </span>sudo<span class="w"> </span><span class="nv">$ENVVARS</span><span class="w"> </span>bash<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCRIPT_NAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">exec</span><span class="w"> </span>sudo<span class="w"> </span><span class="nv">$ENVVARS</span><span class="w"> </span>bash<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SCRIPT_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ORIGINAL_ARGS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Don&#39;t know how to run the script. Let the user figure it out.</span>
<span class="w">  </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_CANT_SWITCH_TO_ROOT&quot;</span><span class="w"> </span><span class="s2">&quot;ERROR: This script could not detect its own filename, so could not </span>
<span class="s2">switch to root. \</span>
<span class="s2">Please download a copy and name it &#39;install.sh&#39; and run that as root, perhaps using sudo. \</span>
<span class="s2">Try this command:</span>

<span class="s2">curl https://install.sandstorm.io/ &gt; install.sh &amp;&amp; sudo bash install.sh&quot;</span>
<span class="o">}</span>

set_umask<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Use umask 0022, to minimize how much &#39;mkdir -m&#39; we have to do, etc. See #2300.</span>
<span class="w">  </span><span class="nb">umask</span><span class="w"> </span><span class="m">0022</span>
<span class="o">}</span>

assert_on_terminal<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-t<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_NO_TTY&quot;</span><span class="w"> </span><span class="s2">&quot;This script is interactive. Please run it on a terminal.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Hack: If the script is being read in from a pipe, then FD 0 is not the terminal input. But we</span>
<span class="w">  </span><span class="c1">#   need input from the user! We just verified that FD 1 is a terminal, therefore we expect that</span>
<span class="w">  </span><span class="c1">#   we can actually read from it instead. However, &quot;read -u 1&quot; in a script results in</span>
<span class="w">  </span><span class="c1">#   &quot;Bad file descriptor&quot;, even though it clearly isn&#39;t bad (weirdly, in an interactive shell,</span>
<span class="w">  </span><span class="c1">#   &quot;read -u 1&quot; works fine). So, we clone FD 1 to FD 3 and then use that -- bash seems OK with</span>
<span class="w">  </span><span class="c1">#   this.</span>
<span class="w">  </span><span class="nb">exec</span><span class="w"> </span><span class="m">3</span>&lt;<span class="p">&amp;</span><span class="m">1</span>
<span class="o">}</span>

assert_linux_x86_64<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>uname<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>Linux<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_NON_LINUX&quot;</span><span class="w"> </span><span class="s2">&quot;Sandstorm requires Linux. If you want to run Sandstorm on a Windows or</span>
<span class="s2">Mac system, you can use Vagrant or another virtualization tool. See our install documentation:</span>

<span class="s2">- https://docs.sandstorm.io/en/latest/install/&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>x86_64<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_NON_X86_64&quot;</span><span class="w"> </span><span class="s2">&quot;Sorry, the Sandstorm server currently only runs on x86_64 machines.&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

assert_usable_kernel<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">KVERSION</span><span class="o">=(</span><span class="w"> </span><span class="k">$(</span>uname<span class="w"> </span>-r<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;^[0-9.]*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>.<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="k">)</span><span class="w"> </span><span class="o">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>KVERSION<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>&lt;<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span>KVERSION<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>KVERSION<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>&lt;<span class="w"> </span><span class="m">10</span><span class="o">)</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;Detected Linux kernel version: </span><span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_KERNEL_OLDER_THAN_310&quot;</span><span class="w"> </span><span class="s2">&quot;Sorry, your kernel is too old to run Sandstorm. We require kernel&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">         </span><span class="s2">&quot;version 3.10 or newer.&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

maybe_enable_userns_sysctl<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># This function enables the Debian/Ubuntu-specific unprivileged</span>
<span class="w">  </span><span class="c1"># userns sysctl, if the system has it and we want it.</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Only do this when -d is passed. -d means &quot;use defaults suitable for app development&quot;, and</span>
<span class="w">    </span><span class="c1"># we want userns enabled for app development if possible since it enables UID randomization</span>
<span class="w">    </span><span class="c1"># which helps catch app bugs. For the rest of the world, we&#39;re fine using the privileged</span>
<span class="w">    </span><span class="c1"># sandbox instead.</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Not root. Can&#39;t do anything about it.</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-e<span class="w"> </span>/proc/sys/kernel/unprivileged_userns_clone<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># No such sysctl on this system.</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">OLD_VALUE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>&lt;<span class="w"> </span>/proc/sys/kernel/unprivileged_userns_clone<span class="k">)</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OLD_VALUE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Already enabled.</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Enable it.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>sysctl<span class="w"> </span>-wq<span class="w"> </span>kernel.unprivileged_userns_clone<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: Enabled unprivileged user namespaces because you passed -d.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="c1"># Apparently we can&#39;t. Maybe we&#39;re in a Docker container. Give up and use privileged sandbox.</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Also make sure it is re-enabled on boot. If sysctl.d exists, we drop our own config in there.</span>
<span class="w">  </span><span class="c1"># Otherwise we edit sysctl.conf, but that&#39;s less polite.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">SYSCTL_FILENAME</span><span class="o">=</span><span class="s2">&quot;/etc/sysctl.conf&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-d<span class="w"> </span>/etc/sysctl.d<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">SYSCTL_FILENAME</span><span class="o">=</span><span class="s2">&quot;/etc/sysctl.d/50-sandstorm.conf&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SYSCTL_FILENAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; __EOF__</span>

<span class="s"># Enable non-root users to create sandboxes (needed by Sandstorm).</span>
<span class="s">kernel.unprivileged_userns_clone = 1</span>
<span class="s">__EOF__</span>
<span class="w">  </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># We couldn&#39;t make the change permanent, so undo the change. Probably everything will work</span>
<span class="w">    </span><span class="c1"># fine with the privileged sandbox. But if it doesn&#39;t, it&#39;s better that things fail now rather</span>
<span class="w">    </span><span class="c1"># than wait for a reboot.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: Never mind, not enabling userns because can&#39;t write /etc/sysctl.d.&quot;</span>
<span class="w">    </span>sysctl<span class="w"> </span>-wq<span class="w"> </span><span class="s2">&quot;kernel.unprivileged_userns_clone=</span><span class="nv">$OLD_VALUE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

test_if_dev_tcp_works<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># In is_port_bound(), we prefer to use bash /dev/tcp to check if the port is bound. This is</span>
<span class="w">  </span><span class="c1"># available on most Linux distributions, but it is a compile-time flag for bash and at least</span>
<span class="w">  </span><span class="c1"># Debian historically disabled it.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># To test availability, we connect to localhost port 0, which is never available, hoping for a</span>
<span class="w">  </span><span class="c1"># TCP-related error message from bash. We use a subshell here because we don&#39;t care that timeout</span>
<span class="w">  </span><span class="c1"># will return false; we care if the grep returns false.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;: &lt; /dev/tcp/localhost/0&#39;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">&#39;connect:&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Good! bash should get &quot;Connection refused&quot; on this, and this message is prefixed</span>
<span class="w">    </span><span class="c1"># by the syscall it was trying to do, so therefore it tried to connect!</span>
<span class="w">    </span><span class="nv">DEV_TCP_USABLE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">DEV_TCP_USABLE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

assert_dependencies<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUNDLE_FILE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>which<span class="w"> </span>curl<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="o">||</span><span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_CURL_MISSING&quot;</span><span class="w"> </span><span class="s2">&quot;Please install curl(1). Sandstorm uses it to download </span>
<span class="s2">updates.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># To find out if port 80 and 443 are available, we need a working bash /dev/net or `nc` on</span>
<span class="w">  </span><span class="c1"># the path.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEV_TCP_USABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;unchecked&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>test_if_dev_tcp_works
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEV_TCP_USABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>which<span class="w"> </span>nc<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_NC_MISSING&quot;</span><span class="w"> </span><span class="s2">&quot;Please install nc(1). (Package may be called </span>
<span class="s2">&#39;netcat-traditional&#39; or &#39;netcat-openbsd&#39;.)&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span>which<span class="w"> </span>tar<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_TAR_MISSING&quot;</span><span class="w"> </span><span class="s2">&quot;Please install tar(1).&quot;</span>
<span class="w">  </span>which<span class="w"> </span>xz<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_XZ_MISSING&quot;</span><span class="w"> </span><span class="s2">&quot;Please install xz(1). (Package may be called &#39;xz-utils&#39;.)&quot;</span>
<span class="o">}</span>

assert_valid_bundle_file<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># ========================================================================================</span>
<span class="w">  </span><span class="c1"># Validate bundle file, if provided</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUNDLE_FILE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Read the first filename out of the bundle, which should be the root directory name.</span>
<span class="w">    </span><span class="c1"># We use &quot;|| true&quot; here because tar is going to SIGPIPE when `head` exits.</span>
<span class="w">    </span><span class="nv">BUNDLE_DIR</span><span class="o">=</span><span class="k">$(</span><span class="w"> </span><span class="o">(</span>tar<span class="w"> </span>Jtf<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUNDLE_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span><span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUNDLE_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>sandstorm-<span class="o">([</span><span class="m">0</span>-9<span class="o">]</span>+<span class="o">)</span>/<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_INVALID_BUNDLE&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUNDLE_FILE</span><span class="s2">: Not a valid Sandstorm bundle&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">BUILD</span><span class="o">=</span><span class="si">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="si">}</span>

<span class="w">    </span><span class="c1"># We&#39;re going to change directory, so note the bundle&#39;s full name.</span>
<span class="w">    </span><span class="nv">BUNDLE_FILE</span><span class="o">=</span><span class="k">$(</span>readlink<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUNDLE_FILE</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

detect_init_system<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># We start out by not knowing which init system is in use.</span>
<span class="w">  </span><span class="nv">INIT_SYSTEM</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>

<span class="w">  </span><span class="c1"># We look for systemd, since we have a nice way to generate a unit file.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>systemd<span class="w"> </span>/proc/1/comm<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">INIT_SYSTEM</span><span class="o">=</span><span class="s2">&quot;systemd&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># We look for sysvinit, as a convenient fallback. Note that this</span>
<span class="w">  </span><span class="c1"># should work fine with Upstart (on e.g. Ubuntu 14.04), too.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/init.d<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">INIT_SYSTEM</span><span class="o">=</span><span class="s2">&quot;sysvinit&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we got this far, and we couldn&#39;t figure out the init system</span>
<span class="w">  </span><span class="c1"># in use, that&#39;s life.</span>
<span class="o">}</span>

choose_install_mode<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;Sandstorm makes it easy to run web apps on your own server. &#39;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="k">:-</span><span class="nv">development</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">  </span><span class="c1"># dev server mode by default</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREFER_ROOT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: Showing you all options, including development options, but omitting &quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      init script automation, because you chose to install without using root.&quot;</span>
<span class="w">    </span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="k">:-</span><span class="nv">development</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">  </span><span class="c1"># dev server mode by default</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You can have:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;1. A typical install, to use Sandstorm (press enter to accept this default)&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;2. A development server, for working on Sandstorm itself or localhost-based app development&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="o">=</span><span class="k">$(</span>prompt-numeric<span class="w"> </span><span class="s2">&quot;How are you going to use this Sandstorm install?&quot;</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="k">)</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CHOSEN_INSTALL_MODE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CHOSEN_INSTALL_MODE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>assert_full_server_dependencies
<span class="w">    </span>full_server_install
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span>dev_server_install
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

assert_full_server_dependencies<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># To set up sandcats, we need `openssl` on the path. Check for that,</span>
<span class="w">  </span><span class="c1"># and if it is missing, bail out and tell the user they have to</span>
<span class="w">  </span><span class="c1"># install it.</span>
<span class="w">  </span>which<span class="w"> </span>openssl<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="o">||</span><span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_OPENSSL_MISSING&quot;</span><span class="w"> </span><span class="s2">&quot;Please install openssl(1). Sandstorm uses it for the </span>
<span class="s2">Sandcats.io dynamic DNS service.&quot;</span>
<span class="o">}</span>

dev_server_install<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Use these settings for a dev-server-oriented install.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># Users will find themselves going through this flow if they</span>
<span class="w">  </span><span class="c1"># manually choose a dev-server-related flow, but also if they pass</span>
<span class="w">  </span><span class="c1"># -d on the command line. (The Vagrantfile and the test suite both</span>
<span class="w">  </span><span class="c1"># use -d. The test suite runs install.sh with -d -u.)</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># A &quot;dev server install&quot; must be run as root, unless you pass</span>
<span class="w">  </span><span class="c1"># -u. That&#39;s because app development (aka spk dev) requires running</span>
<span class="w">  </span><span class="c1"># as root, at the moment.</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PREFER_ROOT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># We are not root, but we would like to be root.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;If you want app developer mode for a Sandstorm install, you need root&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;due to limitations in the Linux kernel.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;To set up Sandstorm, we will use sudo to switch to root, then&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;provide further information before doing the install.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandstorm&#39;s database and web interface won&#39;t run as root.&quot;</span>

<span class="w">    </span><span class="c1"># If we are running in USE_DEFAULTS mode, then it is not OK to ask</span>
<span class="w">    </span><span class="c1"># for permission to use sudo.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">ACCEPTED_SUDO_FOR_DEV_SERVER</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;OK to continue?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">ACCEPTED_SUDO_FOR_DEV_SERVER</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="nv">ACCEPTED_SUDO_FOR_DEV_SERVER</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ACCEPTED_SUDO_FOR_DEV_SERVER</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>rerun_script_as_root<span class="w"> </span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="o">=</span>development
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># Print a message that allows people to make an informed decision.</span>
<span class="w">      </span><span class="nv">SHOW_FAILURE_MSG</span><span class="o">=</span>no<span class="w"> </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_NEED_ROOT&quot;</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">One development feature does require root. To install anyway, run:</span>

<span class="s2">install.sh -u</span>

<span class="s2">to install without using root access. In that case, Sandstorm will operate OK but package tracing (&#39;spk dev&#39;) </span>
<span class="s2">will not work.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If they did not pass -d, then let them opt into that, but only if</span>
<span class="w">  </span><span class="c1"># PREFER_ROOT is still enabled.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># If they pass -u without -d, then they can answer the questions one</span>
<span class="w">  </span><span class="c1"># by one.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PREFER_ROOT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;We&#39;re going to:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Install Sandstorm in </span><span class="si">${</span><span class="nv">DEFAULT_DIR_FOR_ROOT</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Automatically keep Sandstorm up-to-date (with signed updates).&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Create a service user (</span><span class="nv">$DEFAULT_SERVER_USER</span><span class="s2">) that owns Sandstorm&#39;s files.&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUDO_USER</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Add you (</span><span class="nv">$SUDO_USER</span><span class="s2">) to the </span><span class="nv">$DEFAULT_SERVER_USER</span><span class="s2"> group so you can read/write app data.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Expose the service only on localhost aka local.sandstorm.io, not the public Internet.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Enable &#39;dev accounts&#39;, for easy developer login.&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;unknown&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INIT_SYSTEM</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*** WARNING: Could not detect how to run Sandstorm at startup on your system. ***&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Configure Sandstorm to start on system boot (with </span><span class="nv">$INIT_SYSTEM</span><span class="s2">).&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Listen for inbound email on port </span><span class="si">${</span><span class="nv">DEFAULT_SMTP_PORT</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Press enter to accept defaults. Type &#39;no&#39; to customize.&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">USE_DEFAULTS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;OK. We will prompt you with every question.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Use the default UPDATE_CHANNEL for auto-updates.</span>
<span class="w">    </span><span class="nv">UPDATE_CHANNEL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_UPDATE_CHANNEL</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Bind to localhost, unless -e specified in argv.</span>
<span class="w">    </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="k">:-</span><span class="nv">no</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Use local.sandstorm.io as hostname unless environment variable declared otherwise. This</span>
<span class="w">    </span><span class="c1"># short-circuits the code elsewhere that uses the system hostname if USE_EXTERNAL_INTERFACE is</span>
<span class="w">    </span><span class="c1"># &quot;yes&quot;.</span>
<span class="w">    </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SS_HOSTNAME</span><span class="k">:-</span><span class="nv">local</span><span class="p">.sandstorm.io</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Use 30025 as the default SMTP_LISTEN_PORT.</span>
<span class="w">    </span><span class="nv">SMTP_LISTEN_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_SMTP_PORT</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Start the service at boot, if we can.</span>
<span class="w">    </span><span class="nv">START_AT_BOOT</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">    </span><span class="c1"># Do not ask questions about our dynamic DNS service.</span>
<span class="w">    </span><span class="nv">USE_SANDCATS</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>

<span class="w">    </span><span class="c1"># Reasonable default ports.</span>
<span class="w">    </span><span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_PORT</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Allow the mongo prompting part to determine a reasonable MONGO_PORT.</span>

<span class="w">    </span><span class="c1"># Use the ALLOW_DEV_ACCOUNTS feature, which allows people to log</span>
<span class="w">    </span><span class="c1"># into a Sandstorm instance without setting up any accounts.</span>
<span class="w">    </span><span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">    </span><span class="c1"># Do not bother setting a DESIRED_SERVER_USER. This way, the</span>
<span class="w">    </span><span class="c1"># existing prompting will pick if this should be &quot;sandstorm&quot; (which</span>
<span class="w">    </span><span class="c1"># it should be if we&#39;re running the install script as root) or the</span>
<span class="w">    </span><span class="c1"># currently-logged-in user (which it should be if we&#39;re not root).</span>

<span class="w">    </span><span class="c1"># Do not bother setting a DIR. This way, the existing prompting will</span>
<span class="w">    </span><span class="c1"># pick between /opt/sandstorm and $HOME/sandstorm, depending on if</span>
<span class="w">    </span><span class="c1"># the install is being done as root or not. It will use /opt/sandstorm</span>
<span class="w">    </span><span class="c1"># in all cases if the script is run without the HOME environment variable.</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

full_server_install<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># The full server install assumes you are OK with using root. If</span>
<span class="w">  </span><span class="c1"># you&#39;re not, you should choose the development server and customize</span>
<span class="w">  </span><span class="c1"># it to your heart&#39;s content.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREFER_ROOT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_AUTO_NEEDS_SUDO&quot;</span><span class="w"> </span><span class="s2">&quot;The automatic setup process requires sudo. Try again with option 2, </span>
<span class="s2">development server, to customize.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="p">-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">MSG</span><span class="o">=</span><span class="s2">&quot;For now, USE_DEFAULTS for full server installs requires a DESIRED_SANDCATS_NAME variable.&quot;</span>
<span class="w">      </span><span class="nv">MSG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MSG</span><span class="s2"> If you need support for non-sandcats full-server unattended installs, please file a bug.&quot;</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_USE_DEFAULTS_NEEDS_DESIRED_SANDCATS_NAME&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSG</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_DOMAIN_RESERVATION_TOKEN</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">MSG</span><span class="o">=</span><span class="s2">&quot;When operating in USE_DEFAULTS mode, if you want a sandcats.io domain,&quot;</span>
<span class="w">        </span><span class="nv">MSG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MSG</span><span class="s2"> you must pre-reserve it before running this script. Specify it via the&quot;</span>
<span class="w">        </span><span class="nv">MSG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MSG</span><span class="s2"> SANDCATS_DOMAIN_RESERVATION_TOKEN environment variable.&quot;</span>
<span class="w">        </span>fail<span class="w"> </span><span class="s2">&quot;E_USE_DEFAULTS_NEEDS_DESIRED_SANDCATS_NAME&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSG</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># If they said USE_DEFAULTS then they don&#39;t need to be prompted.</span>
<span class="w">    </span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Use port 25 for email, if we can. This logic only gets executed for &quot;full servers.&quot;</span>
<span class="w">  </span>disable_smtp_port_25_if_port_unavailable
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">PLANNED_SMTP_PORT</span><span class="o">=</span><span class="s2">&quot;30025&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT_25_AVAILABLE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">PLANNED_SMTP_PORT</span><span class="o">=</span><span class="s2">&quot;25&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RERUNNING_AS_ROOT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Determine whether to show the ports unavailable warning</span>
<span class="w">    </span>check_if_ports_unavailable

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;We&#39;re going to:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Install Sandstorm in </span><span class="nv">$DEFAULT_DIR_FOR_ROOT</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Automatically keep Sandstorm up-to-date&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Configure auto-renewing HTTPS if you use a subdomain of sandcats.io&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Create a service user (</span><span class="nv">$DEFAULT_SERVER_USER</span><span class="s2">) that owns Sandstorm&#39;s files&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;unknown&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INIT_SYSTEM</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*** WARNING: Could not detect how to run Sandstorm at startup on your system. ***&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Configure Sandstorm to start on system boot (with </span><span class="nv">$INIT_SYSTEM</span><span class="s2">)&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Listen for inbound email on port </span><span class="si">${</span><span class="nv">PLANNED_SMTP_PORT</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="c1"># If we&#39;re not root, we will ask if it&#39;s OK to use sudo.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;To set up Sandstorm, we will need to use sudo.&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Rest assured that Sandstorm itself won&#39;t run as root.&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;OK to continue?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="o">=</span>yes
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="o">=</span>no
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ACCEPTED_FULL_SERVER_INSTALL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SHOW_MESSAGE_ABOUT_NEEDING_PORTS_OPEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: It looks like your system already has some other web server installed&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      (port 80 and/or 443 are taken), so Sandstorm cannot act as your main&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      web server.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      This script can set up Sandstorm to run on port </span><span class="nv">$DEFAULT_PORT</span><span class="s2"> instead,&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      without HTTPS. This makes sense if you&#39;re OK with typing the port number&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      into your browser whenever you access Sandstorm and you don&#39;t need&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      security. This also makes sense if you are going to set up a reverse proxy;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      if so, see https://docs.sandstorm.io/en/latest/administering/reverse-proxy/&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      If you want, you can quit this script with Ctrl-C now, and go uninstall&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      your other web server, and then run this script again. It is also OK to&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      proceed if you want.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;OK to skip automatic HTTPS setup &amp; bind to port </span><span class="nv">$DEFAULT_PORT</span><span class="s2"> instead?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>fail<span class="w"> </span><span class="s2">&quot;E_USER_REFUSED_DEFAULT_PORT&quot;</span><span class="w"> </span><span class="s2">&quot;Exiting now. You can re-run the installer whenever you are ready.&quot;</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># If they are OK continuing, and the script is not running as root</span>
<span class="w">    </span><span class="c1"># at the moment, then re-run ourselves as root.</span>
<span class="w">    </span><span class="c1">#</span>
<span class="w">    </span><span class="c1"># Pass along enough information so that the script will keep</span>
<span class="w">    </span><span class="c1"># executing smoothly, so the user doesn&#39;t have to re-answer</span>
<span class="w">    </span><span class="c1"># questions.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ACCEPTED_FULL_SERVER_INSTALL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>rerun_script_as_root<span class="w"> </span><span class="nv">CHOSEN_INSTALL_MODE</span><span class="o">=</span>production<span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">RERUNNING_AS_ROOT</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">ACME_EMAIL</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACME_EMAIL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">OVERRIDE_SANDCATS_BASE_DOMAIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_BASE_DOMAIN</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">OVERRIDE_SANDCATS_API_BASE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_API_BASE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">OVERRIDE_NC_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_NC_PATH</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                             </span><span class="nv">OVERRIDE_SANDCATS_CURL_PARAMS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_CURL_PARAMS</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="k">fi</span>

<span class="w">      </span><span class="c1"># If we&#39;re still around, it means they declined to run us as root.</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;The automatic setup script needs root in order to:&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Create a separate user to run Sandstorm as, and&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Set up Sandstorm to start on system boot.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_DECLINED_AUTO_SETUP_DETAILS&quot;</span><span class="w"> </span><span class="s2">&quot;For a customized install, please re-run install.sh, and choose </span>
<span class="s2">option (2) &quot;</span><span class="se">\</span>
<span class="w">           </span><span class="s2">&quot;to do a development install.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Accepting this indicates a few things.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACCEPTED_FULL_SERVER_INSTALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">UPDATE_CHANNEL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_UPDATE_CHANNEL</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_DIR_FOR_ROOT</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">USE_SANDCATS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">START_AT_BOOT</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">DESIRED_SERVER_USER</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_SERVER_USER</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_PORT</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">MONGO_PORT</span><span class="o">=</span><span class="s2">&quot;6081&quot;</span>
<span class="w">    </span><span class="nv">SMTP_LISTEN_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PLANNED_SMTP_PORT</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_USER_WANTS_CUSTOM_SETTINGS&quot;</span><span class="w"> </span><span class="s2">&quot;If you prefer a more manual setup experience, try </span>
<span class="s2">installing in development mode.&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

sandcats_configure<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># We generate the public key before prompting for a desired hostname</span>
<span class="w">  </span><span class="c1"># so that when the user presses enter, we can try to register the</span>
<span class="w">  </span><span class="c1"># hostname, and if that succeeds, we are totally done. This avoids a</span>
<span class="w">  </span><span class="c1"># possible time-of-check-time-of-use race.</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;As a Sandstorm user, you are invited to use a free Internet hostname &quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;as a subdomain of sandcats.io,&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;a service operated by the Sandstorm development team.&quot;</span>

<span class="w">  </span>sandcats_generate_keys

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandcats.io protects your privacy and is subject to terms of use. By using it,&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;you agree to the terms of service &amp; privacy policy available here:&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;https://sandcats.io/terms https://sandcats.io/privacy&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">  </span><span class="c1"># Having set up the keys, we run the function to register a name</span>
<span class="w">  </span><span class="c1"># with Sandcats. This function handles tail-recursing itself until</span>
<span class="w">  </span><span class="c1"># it succeeds and/or returning when the user expresses a desire to</span>
<span class="w">  </span><span class="c1"># cancel the process.</span>
<span class="w">  </span>sandcats_register_name
<span class="o">}</span>

configure_hostnames<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_SANDCATS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># If we&#39;re lucky, the user will be happy with the Sandcats</span>
<span class="w">    </span><span class="c1"># hostname configuration. If not, then we&#39;ll have to actually</span>
<span class="w">    </span><span class="c1"># prompt them.</span>
<span class="w">    </span>sandcats_configure
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Ask the user for port number information. (These functions</span>
<span class="w">  </span><span class="c1"># optionally skip the questions if the details have already been</span>
<span class="w">  </span><span class="c1"># filled in.)</span>
<span class="w">  </span>choose_port
<span class="w">  </span>choose_mongo_port

<span class="w">  </span><span class="c1"># If we are supposed to use the external network interface, then</span>
<span class="w">  </span><span class="c1"># configure the hostname and IP address accordingly.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_EXTERNAL_INTERFACE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">BIND_IP</span><span class="o">=</span><span class="m">0</span>.0.0.0
<span class="w">    </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SS_HOSTNAME</span><span class="k">:-$(</span>hostname<span class="w"> </span>-f<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>hostname<span class="k">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">BIND_IP</span><span class="o">=</span><span class="m">127</span>.0.0.1
<span class="w">    </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span>local.sandstorm.io
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Note: local.sandstorm.io maps to 127.0.0.1, i.e. your local machine.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;For reasons that will become clear in the next step, you should use this&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;instead of &#39;localhost&#39;.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># A typical server&#39;s DEFAULT_BASE_URL is its hostname plus port over HTTP. If the port is 80, then</span>
<span class="w">  </span><span class="c1"># don&#39;t add it to BASE_URL to avoid triggering this bug:</span>
<span class="w">  </span><span class="c1"># https://github.com/sandstorm-io/sandstorm/issues/2252</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">PORT_SUFFIX</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;80&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">PORT_SUFFIX</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">PORT_SUFFIX</span><span class="o">=</span><span class="s2">&quot;:</span><span class="si">${</span><span class="nv">PORT</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">DEFAULT_BASE_URL</span><span class="o">=</span><span class="s2">&quot;http://</span><span class="si">${</span><span class="nv">SS_HOSTNAME</span><span class="si">}${</span><span class="nv">PORT_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_HTTPS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DEFAULT_BASE_URL</span><span class="o">=</span><span class="s2">&quot;https://</span><span class="nv">$SS_HOSTNAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">HTTPS_PORT</span><span class="o">=</span><span class="m">443</span>
<span class="w">    </span><span class="nv">PORT</span><span class="o">=</span><span class="m">80</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SANDCATS_SUCCESSFUL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Do not prompt for BASE_URL configuration if Sandcats bringup</span>
<span class="w">    </span><span class="c1"># succeeded.</span>
<span class="w">    </span><span class="nv">BASE_URL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_BASE_URL</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">BASE_URL</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;URL users will enter in browser:&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEFAULT_BASE_URL</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BASE_URL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^http<span class="o">(</span>s?<span class="o">)</span>://<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">PROPOSED_BASE_URL</span><span class="o">=</span><span class="s2">&quot;http://</span><span class="si">${</span><span class="nv">BASE_URL</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;** You entered </span><span class="si">${</span><span class="nv">BASE_URL</span><span class="si">}</span><span class="s2">, which needs http:// at the front. I can use:&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;        </span><span class="si">${</span><span class="nv">PROPOSED_BASE_URL</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Is this OK?&quot;</span><span class="w"> </span>yes<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">BASE_URL</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROPOSED_BASE_URL</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span>configure_hostnames
<span class="w">      </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If the BASE_URL looks like localhost, then we had better use a</span>
<span class="w">  </span><span class="c1"># DEFAULT_WILDCARD of local.sandstorm.io so that wildcard DNS works.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BASE_URL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^http://localhost<span class="o">(</span><span class="p">|</span>:<span class="o">[</span><span class="m">0</span>-9<span class="o">]</span>*<span class="o">)(</span>/.*<span class="o">)</span>?$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DEFAULT_WILDCARD</span><span class="o">=</span>*.local.sandstorm.io<span class="si">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="si">}</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BASE_URL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span>^:/<span class="o">]</span>*://<span class="o">([</span>^/<span class="o">]</span>*<span class="o">)</span>/?$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DEFAULT_WILDCARD</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_WILDCARD</span><span class="k">:-</span><span class="p">*.</span><span class="si">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="si">}}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">DEFAULT_WILDCARD</span><span class="o">=</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we did the sandcats configuration, then we trust it to provide</span>
<span class="w">  </span><span class="c1"># a working WILDCARD_HOST.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SANDCATS_SUCCESSFUL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">WILDCARD_HOST</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_WILDCARD</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_DEFAULTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandstorm requires you to set up a wildcard DNS entry pointing at the server.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;This allows Sandstorm to allocate new hosts on-the-fly for sandboxing purposes.&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Please enter a DNS hostname containing a &#39;*&#39; which maps to your server. For &quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;example, if you have mapped *.foo.example.com to your server, you could enter&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;\&quot;*.foo.example.com\&quot;. You can also specify that hosts should have a special&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;prefix, like \&quot;ss-*.foo.example.com\&quot;. Note that if your server&#39;s main page&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;is served over SSL, the wildcard address must support SSL as well, which&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;implies that you must have a wildcard certificate. For local-machine servers,&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;we have mapped *.local.sandstorm.io to 127.0.0.1 for your convenience, so you&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;can use \&quot;*.local.sandstorm.io\&quot; here. If you are serving off a non-standard&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;port, you must include it here as well.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nv">WILDCARD_HOST</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Wildcard host:&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEFAULT_WILDCARD</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WILDCARD_HOST</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span>^*<span class="o">]</span>*<span class="o">[</span>*<span class="o">][</span>^*<span class="o">]</span>*$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span>error<span class="w"> </span><span class="s2">&quot;Invalid wildcard host. It must contain exactly one asterisk.&quot;</span>
<span class="w">      </span><span class="nv">WILDCARD_HOST</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Wildcard host:&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEFAULT_WILDCARD</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

choose_install_dir<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DIR</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">DEFAULT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_DIR_FOR_ROOT</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">DEFAULT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DEFAULT_DIR_FOR_NON_ROOT</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">DIR</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Where would you like to put Sandstorm?&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DEFAULT_DIR</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Check for the existence of any partial Sandstorm installation. Note that by default, the</span>
<span class="w">  </span><span class="c1"># Sandstorm uninstall process will retain $DIR/sandstorm.conf and $DIR/var. Since the install</span>
<span class="w">  </span><span class="c1"># script can&#39;t reliably use those to preseed a new Sandstorm install, we still bail out in that</span>
<span class="w">  </span><span class="c1"># situation.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">/sandstorm.conf&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">/var&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">/sandstorm&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Clear the previous line, since in many cases, it&#39;s a &quot;echo -n&quot;.</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;This script is trying to install to </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;You seem to already have a </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2"> directory with a Sandstorm installation inside. You should </span>
<span class="s2">either:&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;1. Reconfigure that Sandstorm install using its configuration file -- </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">/sandstorm.conf -- or </span>
<span class="s2">the admin interface. See docs at:&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;https://docs.sandstorm.io/en/latest/administering/&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;2. Uninstall Sandstorm before attempting to perform a new install. Even if you created a </span>
<span class="s2">sandcats.io hostname, it is safe to uninstall so long as you do not need the data in your Sandstorm install. </span>
<span class="s2">When you re-install Sandstorm, you can follow a process to use the old hostname with the new install. See </span>
<span class="s2">uninstall docs at:&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;https://docs.sandstorm.io/en/latest/install/#uninstall&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;3. Use a different target directory for the new Sandstorm install. Try running install.sh with the </span>
<span class="s2">-d option.&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;4. Retain your data, but restore your Sandstorm code and configuration to a fresh copy. To do </span>
<span class="s2">that, keep a backup  of </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">/var and then do a fresh install; stop the Sandstorm service, and restore your </span>
<span class="s2">backup of </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">/var. You may need to adjust permissions after doing that.&quot;</span>
<span class="w">    </span><span class="nv">REPORT</span><span class="o">=</span>no<span class="w"> </span>fail<span class="w"> </span><span class="s2">&quot;E_DIR_ALREADY_EXISTS&quot;</span><span class="w"> </span><span class="s2">&quot;Please try one of the above. Contact </span>
<span class="s2">https://groups.google.com/d/forum/sandstorm-dev for further help.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">&quot;</span>
<span class="o">}</span>

choose_smtp_port<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If SMTP_LISTEN_PORT is already decided, then don&#39;t bother asking.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SMTP_LISTEN_PORT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">REQUESTED_SMTP_PORT</span><span class="o">=</span><span class="k">$(</span>prompt-numeric<span class="w"> </span><span class="s2">&quot;Sandstorm grains can receive email. What port should Sandstorm </span>
<span class="s2">listen on, for inbound SMTP?&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_SMTP_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REQUESTED_SMTP_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>choose_smtp_port
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">SMTP_LISTEN_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REQUESTED_SMTP_PORT</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

load_existing_settings<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If there is no settings file to load, then we can skip the</span>
<span class="w">  </span><span class="c1"># rest of this function.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-e<span class="w"> </span>sandstorm.conf<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Found existing sandstorm.conf. Using it.&quot;</span>
<span class="w">  </span>.<span class="w"> </span>sandstorm.conf
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SERVER_USER</span><span class="p">:+set</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_CONF_DOES_NOT_SET_SERVER_USER&quot;</span><span class="w"> </span><span class="s2">&quot;Existing config does not set SERVER_USER. Please fix or delete </span>
<span class="s2">it.&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If sandstorm.conf specifies an UPDATE_CHANNEL, then make that be</span>
<span class="w">  </span><span class="c1"># the default. Additionally, because UPDATE_CHANNEL is already</span>
<span class="w">  </span><span class="c1"># set, the part of the code that prompts the user about what</span>
<span class="w">  </span><span class="c1"># UPDATE_CHANNEL they want should skip itself.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">UPDATE_CHANNEL</span><span class="k">:-</span><span class="nv">none</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>none<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DEFAULT_UPDATE_CHANNEL</span><span class="o">=</span><span class="nv">$UPDATE_CHANNEL</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

choose_server_user_if_needed<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If there is already a sandstorm.conf, we assume that it has a</span>
<span class="w">  </span><span class="c1"># SERVER_USER set and that the user exists. This is a</span>
<span class="w">  </span><span class="c1"># basically-reasonable assumption, given that</span>
<span class="w">  </span><span class="c1"># load_existing_settings() verifies that there is a SERVER_USER set.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>sandstorm.conf<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we are not root, then life is easy; we run Sandstorm as the current</span>
<span class="w">  </span><span class="c1"># user.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">SERVER_USER</span><span class="o">=</span><span class="k">$(</span>id<span class="w"> </span>-un<span class="k">)</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If previous configuration (e.g. easy-configuration, option 1) requested a</span>
<span class="w">  </span><span class="c1"># specific SERVER_USER, then let&#39;s go with that.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SERVER_USER</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">SERVER_USER</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DESIRED_SERVER_USER</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">CREATE_SERVER_USER</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">ADD_SUDO_USER_TO_SERVER_GROUP</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we got this far, then we need to ask.</span>
<span class="w">  </span><span class="nv">SERVER_USER</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Local user account to run server under:&quot;</span><span class="w"> </span>sandstorm<span class="k">)</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>root<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandstorm cannot run as root!&quot;</span>
<span class="w">    </span><span class="nv">SERVER_USER</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Local user account to run server under:&quot;</span><span class="w"> </span>sandstorm<span class="k">)</span>
<span class="w">  </span><span class="k">done</span>
<span class="o">}</span>

create_server_user_if_needed<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Find out if the user exists. If so, then we&#39;re done!</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>id<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Since the server user does not exist, we create it (asking for</span>
<span class="w">  </span><span class="c1"># permission if necessary).</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CREATE_SERVER_USER</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;User account &#39;</span><span class="nv">$SERVER_USER</span><span class="s2">&#39; doesn&#39;t exist. Create it?&quot;</span><span class="w"> </span>yes<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">CREATE_SERVER_USER</span><span class="o">=</span>yes
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If people don&#39;t want us to create it, then let&#39;s bail now.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CREATE_SERVER_USER</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># OK! Let&#39;s proceed.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># To create the server user, we first try `useradd`, which is widely available on most</span>
<span class="w">  </span><span class="c1"># distros. If that isn&#39;t available, it&#39;s likely we&#39;re running on a busybox based system.</span>
<span class="w">  </span><span class="c1"># busybox provides an `adduser` applet, so if that command links to the busybox binary</span>
<span class="w">  </span><span class="c1"># we it instead.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># Note that debian provides an `adduser` command as well, but its usage is different.</span>
<span class="w">  </span><span class="c1"># useradd is available on debian anyway, so we&#39;ll end up using that.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>which<span class="w"> </span>useradd<span class="w"> </span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Per the man page for useradd, USERGROUPS_ENAB in /etc/login.defs controls if useradd</span>
<span class="w">    </span><span class="c1"># will automatically create a group for this user (the new group would have the same</span>
<span class="w">    </span><span class="c1"># name as the new user). On systems such as OpenSuSE where that flag is set to false</span>
<span class="w">    </span><span class="c1"># by default, or on systems where the administrator has personally tuned that flag,</span>
<span class="w">    </span><span class="c1"># we need to provide --user-group to useradd so that it creates the group.</span>
<span class="w">    </span>useradd<span class="w"> </span>--system<span class="w"> </span>--user-group<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="k">$(</span>readlink<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>adduser<span class="k">)))</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>busybox<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># With busybox we need to separately create the user&#39;s group.</span>
<span class="w">    </span>addgroup<span class="w"> </span>-S<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span>
<span class="w">    </span>adduser<span class="w"> </span>-S<span class="w"> </span>-G<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_NO_USERADD&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;Couldn&#39;t find a command with which to add a user (either useradd or busybox).&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Note: Sandstorm&#39;s storage will only be accessible to the group &#39;</span><span class="nv">$SERVER_USER</span><span class="s2">&#39;.&quot;</span>

<span class="w">  </span><span class="c1"># If SUDO_USER is non-empty, we let the user opt in to adding</span>
<span class="w">  </span><span class="c1"># themselves to the storage group.</span>

<span class="w">  </span><span class="c1"># The easy-install opts out of this flow by setting</span>
<span class="w">  </span><span class="c1"># ADD_SUDO_USER_TO_SERVER_GROUP=no.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ADD_SUDO_USER_TO_SERVER_GROUP</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUDO_USER</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Add user &#39;</span><span class="nv">$SUDO_USER</span><span class="s2">&#39; to group &#39;</span><span class="nv">$SERVER_USER</span><span class="s2">&#39;?&quot;</span><span class="w"> </span>no<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>usermod<span class="w"> </span>-a<span class="w"> </span>-G<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SUDO_USER</span><span class="s2">&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Added. Don&#39;t forget that group changes only apply at next login.&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

choose_port<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If there already is a PORT chosen, then don&#39;t bother asking.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PORT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">PORT</span><span class="o">=</span><span class="k">$(</span>prompt-numeric<span class="w"> </span><span class="s2">&quot;Server main HTTP port:&quot;</span><span class="w"> </span><span class="nv">$DEFAULT_PORT</span><span class="k">)</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ports below 1024 require root privileges. Sandstorm does not run as root.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;To use port </span><span class="nv">$PORT</span><span class="s2">, you&#39;ll need to set up a reverse proxy like nginx that &quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;forwards to the internal higher-numbered port. The Sandstorm git repo &quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;contains an example nginx config for this.&quot;</span>
<span class="w">    </span><span class="nv">PORT</span><span class="o">=</span><span class="k">$(</span>prompt-numeric<span class="w"> </span><span class="s2">&quot;Server main HTTP port:&quot;</span><span class="w"> </span><span class="nv">$DEFAULT_PORT</span><span class="k">)</span>
<span class="w">  </span><span class="k">done</span>
<span class="o">}</span>

choose_mongo_port<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If there is already a MONGO_PORT chosen, then don&#39;t bother asking.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MONGO_PORT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If the port we&#39;ll bind is less than 1024, then default to MONGO_PORT of 6081 because</span>
<span class="w">  </span><span class="c1"># mongo can&#39;t listen on root-owned ports in our configuration.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">DEFAULT_MONGO_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$((</span><span class="nv">PORT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">DEFAULT_MONGO_PORT</span><span class="o">=</span><span class="s2">&quot;6081&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">MONGO_PORT</span><span class="o">=</span><span class="k">$(</span>prompt-numeric<span class="w"> </span><span class="s2">&quot;Database port (choose any unused port):&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEFAULT_MONGO_PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="o">}</span>

choose_external_or_internal<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Figure out if we want to listen on internal vs. external interfaces.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_EXTERNAL_INTERFACE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Expose to localhost only?&quot;</span><span class="w"> </span>yes<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

configure_auto_updates<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If UPDATE_CHANNEL is non-empty, then skip this.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">UPDATE_CHANNEL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Otherwise, ask!</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Automatically keep Sandstorm updated?&quot;</span><span class="w"> </span>yes<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">UPDATE_CHANNEL</span><span class="o">=</span><span class="nv">$DEFAULT_UPDATE_CHANNEL</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">UPDATE_CHANNEL</span><span class="o">=</span>none
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

configure_dev_accounts<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If ALLOW_DEV_ACCOUNTS is set to yes already, then skip this.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If USE_EXTERNAL_INTERFACE is set to yes, then skip this, because</span>
<span class="w">  </span><span class="c1"># dev accounts on the Internet would be crazy.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandstorm supports &#39;dev accounts&#39;, a feature that lets anyone log in&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;as admin and other sample users to a Sandstorm server. We recommend&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;it for app development, and absolutely do not recommend it for&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;a server on the public Internet.&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Enable dev accounts?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="o">=</span>yes
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

save_config<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>writeConfig<span class="w"> </span>SERVER_USER<span class="w"> </span>PORT<span class="w"> </span>MONGO_PORT<span class="w"> </span>BIND_IP<span class="w"> </span>BASE_URL<span class="w"> </span>WILDCARD_HOST<span class="w"> </span>UPDATE_CHANNEL<span class="w"> </span>ALLOW_DEV_ACCOUNTS<span class="w"> </span>
SMTP_LISTEN_PORT<span class="w"> </span>&gt;<span class="w"> </span>sandstorm.conf
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SANDCATS_SUCCESSFUL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>writeConfig<span class="w"> </span>SANDCATS_BASE_DOMAIN<span class="w"> </span>&gt;&gt;<span class="w"> </span>sandstorm.conf
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USE_HTTPS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>writeConfig<span class="w"> </span>HTTPS_PORT<span class="w"> </span>&gt;&gt;<span class="w"> </span>sandstorm.conf
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Config written to </span><span class="nv">$PWD</span><span class="s2">/sandstorm.conf.&quot;</span>
<span class="o">}</span>

download_latest_bundle_and_extract_if_needed<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If BUNDLE_FILE is non-empty, we were provided a bundle file, so we</span>
<span class="w">  </span><span class="c1"># can skip downloading one.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUNDLE_FILE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Finding latest build for </span><span class="nv">$DEFAULT_UPDATE_CHANNEL</span><span class="s2"> channel...&quot;</span>
<span class="w">  </span><span class="c1"># NOTE: The type is install_v2. We use the &quot;type&quot; value when calculating how many people attempted</span>
<span class="w">  </span><span class="c1"># to do a Sandstorm install. We had to stop using &quot;install&quot; because vagrant-spk happens to use</span>
<span class="w">  </span><span class="c1"># &amp;type=install during situations that we do not want to categorize as an attempt by a human to</span>
<span class="w">  </span><span class="c1"># install Sandstorm.</span>
<span class="w">  </span><span class="nv">BUILD</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>curl<span class="w"> </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span>-fs<span class="w"> </span>
<span class="s2">&quot;https://install.sandstorm.io/</span><span class="nv">$DEFAULT_UPDATE_CHANNEL</span><span class="s2">?from=0&amp;type=install_v2&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">BUILD_DIR</span><span class="o">=</span><span class="s2">&quot;sandstorm-</span><span class="si">${</span><span class="nv">BUILD</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span><span class="m">0</span>-9<span class="o">]</span>+$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_INVALID_BUILD_NUM&quot;</span><span class="w"> </span><span class="s2">&quot;Server returned invalid build number: </span><span class="nv">$BUILD</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">do</span>-download<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">WORK_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>mktemp<span class="w"> </span>-d<span class="w"> </span>./sandstorm-installer.XXXXXXXXXX<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">URL</span><span class="o">=</span><span class="s2">&quot;https://dl.sandstorm.io/sandstorm-</span><span class="nv">$BUILD</span><span class="s2">.tar.xz&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Downloading: </span><span class="nv">$URL</span><span class="s2">&quot;</span>
<span class="w">    </span>retryable_curl<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">/sandstorm-</span><span class="nv">$BUILD</span><span class="s2">.tar.xz&quot;</span>
<span class="w">    </span>retryable_curl<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">.sig&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">/sandstorm-</span><span class="nv">$BUILD</span><span class="s2">.tar.xz.sig&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>which<span class="w"> </span>gpg<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">export</span><span class="w"> </span><span class="nv">GNUPGHOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">/.gnupg&quot;</span>
<span class="w">      </span>mkdir<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GNUPGHOME</span><span class="s2">&quot;</span>

<span class="w">      </span><span class="c1"># Regenerate with: gpg --armor --export 160D2D577518B58D94C9800B63F227499DA8CCBD</span>
<span class="w">      </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">/sandstorm-keyring.gpg&quot;</span><span class="w"> </span><span class="s">&lt;&lt; __EOF__</span>
<span class="s">-----BEGIN PGP PUBLIC KEY BLOCK-----</span>
<span class="s">Version: GnuPG v1</span>

<span class="s">mQENBFX8ypkBCAC8sjX5yZqKdW8nY7aE/GpVeS+qSCbpYSJwixYNFXbz3MQihR3S</span>
<span class="s">suvg5uw1KyuQb23c0LwirfxazVf7txKhQNaNU3ek62LG3wcGeBrvQGsIUMbkatay</span>
<span class="s">/163CLeVWfSK1Z4pFc4dhdjXYSOz0oZxd7Mp78crBbGKmyn7PtzdAqt+XfEXNuee</span>
<span class="s">cDbx++P57n5s5xc5fQWznt333IMgmgTREGUROfh4kL376rFAS208XIywJlUVkoKM</span>
<span class="s">kIzgcjevFGwYKdsLigHXCDp9toQHl8oPjFV+RE8Br8ciJlMp9CqCfHGwj0Orxasc</span>
<span class="s">e9moLqqUc+iKdg9bQfuAbJ/jFNhGmV/CVv9tABEBAAG0LlNhbmRzdG9ybS5pbyAo</span>
<span class="s">cmVsZWFzZXMpIDxzdXBwb3J0QHNhbmRzdG9ybS5pbz6JATgEEwECACIFAlX8ypkC</span>
<span class="s">GwMGCwkIBwMCBhUIAgkKCwQWAgMBAh4BAheAAAoJEGPyJ0mdqMy91bYH/iTg9qbw</span>
<span class="s">G3th57Yf70NtyMJE3UBFDYDNAgT45UBEHoHhQM5cdFu/EIHggOKl/A2zL19Nh555</span>
<span class="s">5F5o3jiJChQ0cvpoVnDdA5lRKD9iK6hzAba9fCVAx/od1PULQP7KV+uHTQuclSFO</span>
<span class="s">DBvpgT8bMY9LmlpTl+l2lvYd+c50w3jZMFwh8JrJYAc3X0kBfVEywVZkjH8Nw5nD</span>
<span class="s">v/j5Of3XXfEg84tNyWSYUMrYVORJyfHtA9e3JXNv5BMxH73AVLnyCJhCaodQsC6Z</span>
<span class="s">hFkHUvvRb58ZqKXMtLYTd/8XLIvpkgRNX6EHWDslJh3BaBwHSuqDNssh1TW5xPjA</span>
<span class="s">9vkPDzeZfLkuxpy5AQ0EVfzKmQEIANyi22M/3KhkghsPA6Rpha1lx6JJCb4p7E21</span>
<span class="s">y82OGFUwcMpZkSgh1lARgp/Mvc2CHhAXi6NkGbgYc1q5rgARSvim2EMZNQOEqRb9</span>
<span class="s">teEeI3w7Nz8Q/WoWck9WaXg8EdELtBOXYgVEirVddUl6ftUvCeBh3hE2Y/CLQSXL</span>
<span class="s">CYXdQ2/MN6xV8tepuWOu0aPxxPUNea9ceDNZ8/CXEL32pzv9SUX/3KgSnFTzmxNP</span>
<span class="s">thzXGuaAQGMZRu3cdTSeK9UUX4L3lxv7p0nE/2K18MU3FayTJqspfUCc4BgHZRMN</span>
<span class="s">sh+2/YNfJgi0uWex1WnU94ZIp4A0uic54bU1ZECSwxg81KHaEEkAEQEAAYkBHwQY</span>
<span class="s">AQIACQUCVfzKmQIbDAAKCRBj8idJnajMvZgPB/0THpTPnfsYNkwQrBsrTq413ZTF</span>
<span class="s">JmVyeZ9xnGDImOdyHhGLlnLC1YEnaNUVEyMKifya4TF2utrLrsMT9TC/dWvFsYlJ</span>
<span class="s">oMcUpaSlrFoAoPp3pdOGCIRYNhWGHoxy0Ti1WAa/6A+GoHJpUEz85/jD4vjgYlCX</span>
<span class="s">ZFW1Pji9PbdIZFZQR4FyYBkkZOUq6yyTNR0syQPVy3EsPVvXzszm2zV/1YjGymgj</span>
<span class="s">MKeYR9+VU+PlFAY9wwLWLTFeSzxTyVjbPwF5bWHV32GM8g0/NgA6a1JLL40v7pqf</span>
<span class="s">uYvFk2KJpo3gZNGJ72gLkSzie7Eu1/V67JIG9TwfrJUEj8Uwd5zPv1MOqfWl</span>
<span class="s">=OiS5</span>
<span class="s">-----END PGP PUBLIC KEY BLOCK-----</span>
<span class="s">__EOF__</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span>gpg<span class="w"> </span>--no-default-keyring<span class="w"> </span>--keyring<span class="w"> </span><span class="nv">$WORK_DIR</span>/sandstorm-keyring.gpg<span class="w"> </span>--status-fd<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--verify<span class="w"> </span><span class="nv">$WORK_DIR</span>/sandstorm-<span class="nv">$BUILD</span>.tar.xz<span class="o">{</span>.sig,<span class="o">}</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">&#39;^\[GNUPG:\] VALIDSIG 160D2D577518B58D94C9800B63F227499DA8CCBD &#39;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;GPG signature is valid.&quot;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span>rm<span class="w"> </span>-rf<span class="w"> </span>sandstorm-<span class="nv">$BUILD</span>
<span class="w">        </span>fail<span class="w"> </span><span class="s2">&quot;E_INVALID_GPG_SIG&quot;</span><span class="w"> </span><span class="s2">&quot;GPG signature is NOT valid! Please report to security@sandstorm.io </span>
<span class="s2">immediately!&quot;</span>
<span class="w">      </span><span class="k">fi</span>

<span class="w">      </span><span class="nb">unset</span><span class="w"> </span>GNUPGHOME
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;WARNING: gpg not installed; not verifying signatures (but it&#39;s HTTPS so you&#39;re probably fine)&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>tar<span class="w"> </span>Jxof<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">/sandstorm-</span><span class="nv">$BUILD</span><span class="s2">.tar.xz&quot;</span>
<span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$WORK_DIR</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_BAD_PACKAGE&quot;</span><span class="w"> </span><span class="s2">&quot;Bad package -- did not contain </span><span class="nv">$BUILD_DIR</span><span class="s2"> directory.&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># We used to reject packages older than 30 days on the assumption the package would definitely</span>
<span class="w">    </span><span class="c1"># be updated more often than that. For about six years the existence of this check was the main</span>
<span class="w">    </span><span class="c1"># thing that drove me (Kenton) to do a release every month, although I occasionally forgot which</span>
<span class="w">    </span><span class="c1"># would temporarily block new installs. Surprisingly (to me, at least), whenever this happend,</span>
<span class="w">    </span><span class="c1"># people would actually notice and complain within a day or two -- people were apparently</span>
<span class="w">    </span><span class="c1"># still installing Sandstorm regularly.</span>
<span class="w">    </span><span class="c1">#</span>
<span class="w">    </span><span class="c1"># As of Feb 2023, though, I think it&#39;s time to retire this check and end the monthly update</span>
<span class="w">    </span><span class="c1"># schedule, for several reasons:</span>
<span class="w">    </span><span class="c1"># - In 2022, the majority of months saw no actual changes at all.</span>
<span class="w">    </span><span class="c1"># - Ian, who had been the most active maintainer, is now focusing his efforts on a new</span>
<span class="w">    </span><span class="c1">#   implementation called Tempest. So 2023 is likely to see even fewer changes.</span>
<span class="w">    </span><span class="c1"># - It&#39;s no longer possible to update the Meteor dependency, because newer versions of Meteor</span>
<span class="w">    </span><span class="c1">#   no longer support the ancient version of Mongo we&#39;re stuck on (2.6), and writing automation</span>
<span class="w">    </span><span class="c1">#   to update everyone&#39;s Mongo instances automatically without breaking anyone is too large</span>
<span class="w">    </span><span class="c1">#   a project for anyone to volunteer for. Since almost all of Sandstorm&#39;s dependencies stem</span>
<span class="w">    </span><span class="c1">#   from Meteor, trying to update dependencies on a monthly basis has become futile, as the</span>
<span class="w">    </span><span class="c1">#   pinned Meteor version holds everything else back.</span>
<span class="w">    </span><span class="c1"># - I just have too much to do, and although releases are not a whole lot of work, it feels</span>
<span class="w">    </span><span class="c1">#   like one more thing on the pile.</span>
<span class="w">    </span><span class="c1">#</span>
<span class="w">    </span><span class="c1"># I&#39;m still happy to push releases when there are interesting changes.</span>
<span class="c1">#    if [ ! -e &quot;$BUILD_DIR/buildstamp&quot; ] || \</span>
<span class="c1">#       [ $(stat -c %Y &quot;$BUILD_DIR/buildstamp&quot;) -lt $(( $(date +%s) - 30*24*60*60 )) ]; then</span>
<span class="c1">#      rm -rf &quot;$BUILD_DIR&quot;</span>
<span class="c1">#      fail &quot;E_PKG_STALE&quot; &quot;The downloaded package seems to be more than a month old. Please verify that your&quot; </span>
<span class="se">\</span>
<span class="c1">#           &quot;computer&#39;s clock is correct and try again. It could also be that an attacker is&quot; \</span>
<span class="c1">#           &quot;trying to trick you into installing an old version. Please contact&quot; \</span>
<span class="c1">#           &quot;security@sandstorm.io if the problem persists.&quot;</span>
<span class="c1">#    fi</span>
<span class="w">  </span><span class="o">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$BUILD_DIR</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD_DIR</span><span class="s2"> is already present. Should I use it or re-download?&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Use existing copy?&quot;</span><span class="w"> </span>yes<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">do</span>-download
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">do</span>-download
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

extract_bundle_if_provided<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If BUNDLE_FILE is empty, it means that we have no bundle file to extract,</span>
<span class="w">  </span><span class="c1"># so we can skip downloading it.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUNDLE_FILE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Use the specified local bundle, which we already validated earlier.</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$BUILD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">BUILD_DIR</span><span class="o">=</span>sandstorm-custom.<span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d_%H-%M-%S&#39;</span><span class="k">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nv">BUILD_DIR</span><span class="o">=</span>sandstorm-<span class="nv">$BUILD</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD_DIR</span><span class="s2">&quot;</span>
<span class="w">  </span>mkdir<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD_DIR</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="o">(</span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUILD_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>Jxof<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BUNDLE_FILE</span><span class="s2">&quot;</span><span class="w"> </span>--strip<span class="o">=</span><span class="m">1</span><span class="o">)</span>
<span class="o">}</span>

make_runtime_directories<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">GROUP</span><span class="o">=</span><span class="k">$(</span>id<span class="w"> </span>-g<span class="w"> </span><span class="nv">$SERVER_USER</span><span class="k">)</span>

<span class="w">  </span><span class="c1"># Make var directories.</span>
<span class="w">  </span>mkdir<span class="w"> </span>-p<span class="w"> </span>var/<span class="o">{</span>log,pid,mongo<span class="o">}</span><span class="w"> </span>var/sandstorm/<span class="o">{</span>apps,grains,downloads<span class="o">}</span>

<span class="w">  </span><span class="c1"># Create useful symlinks.</span>
<span class="w">  </span>ln<span class="w"> </span>-sfT<span class="w"> </span><span class="nv">$BUILD_DIR</span><span class="w"> </span>latest
<span class="w">  </span>ln<span class="w"> </span>-sfT<span class="w"> </span>latest/sandstorm<span class="w"> </span>sandstorm
<span class="o">}</span>

set_permissions<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If not running the installer as root, we can&#39;t do all the</span>
<span class="w">  </span><span class="c1"># permissions stuff we want to.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">ADMIN_TOKEN_PATH</span><span class="o">=</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ADMIN_TOKEN_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">ADMIN_TOKEN_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandstorm/adminToken&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Set ownership of files.  We want the dirs to be root:sandstorm but the contents to be</span>
<span class="w">  </span><span class="c1"># sandstorm:sandstorm.</span>
<span class="w">  </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="nv">$SERVER_USER</span>:<span class="nv">$GROUP</span><span class="w"> </span>var/<span class="o">{</span>log,pid,mongo<span class="o">}</span><span class="w"> </span>var/sandstorm/<span class="o">{</span>apps,grains,downloads<span class="o">}</span><span class="w"> </span><span class="nv">$ADMIN_TOKEN_PATH</span>
<span class="w">  </span>chown<span class="w"> </span>root:<span class="nv">$GROUP</span><span class="w"> </span>var/<span class="o">{</span>log,pid,mongo,sandstorm<span class="o">}</span><span class="w"> </span>var/sandstorm/<span class="o">{</span>apps,grains,downloads<span class="o">}</span><span class="w"> </span><span class="nv">$ADMIN_TOKEN_PATH</span>
<span class="w">  </span>chmod<span class="w"> </span>-R<span class="w"> </span><span class="nv">g</span><span class="o">=</span>rwX,o<span class="o">=</span><span class="w"> </span>var/<span class="o">{</span>log,pid,mongo,sandstorm<span class="o">}</span><span class="w"> </span>var/sandstorm/<span class="o">{</span>apps,grains,downloads<span class="o">}</span><span class="w"> </span><span class="nv">$ADMIN_TOKEN_PATH</span>
<span class="o">}</span>

install_sandstorm_symlinks<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If not running the installer as root, we can&#39;t modify</span>
<span class="w">  </span><span class="c1"># /usr/local/bin, so we have to skip this.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">FAILED_TO_WRITE_SYMLINK</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>

<span class="w">  </span><span class="c1"># Install tools.</span>
<span class="w">  </span>ln<span class="w"> </span>-sfT<span class="w"> </span><span class="nv">$PWD</span>/sandstorm<span class="w"> </span>/usr/local/bin/sandstorm<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">FAILED_TO_WRITE_SYMLINK</span><span class="o">=</span>yes
<span class="w">  </span>ln<span class="w"> </span>-sfT<span class="w"> </span><span class="nv">$PWD</span>/sandstorm<span class="w"> </span>/usr/local/bin/spk<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">FAILED_TO_WRITE_SYMLINK</span><span class="o">=</span>yes

<span class="w">  </span><span class="c1"># If /usr/local/bin is not actually writeable, even though we are root, then bail on this for now.</span>
<span class="w">  </span><span class="c1"># That can happen on e.g. CoreOS; see https://github.com/sandstorm-io/sandstorm/issues/1660</span>
<span class="w">  </span><span class="c1"># the bash &quot;-w&quot; does not detect read-only mounts, so we use a behavior check above.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FAILED_TO_WRITE_SYMLINK</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*** WARNING: /usr/local/bin was not writeable. To run sandstorm or spk manually, use:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; - </span><span class="nv">$PWD</span><span class="s2">/sandstorm&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; - </span><span class="nv">$PWD</span><span class="s2">/sandstorm spk&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="o">}</span>

ask_about_starting_at_boot<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># Starting Sandstorm at boot cannot work if we are not root by this point.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">START_AT_BOOT</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If we already know if we want to start the thing at boot, we can skip asking.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">START_AT_BOOT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>prompt-yesno<span class="w"> </span><span class="s2">&quot;Start sandstorm at system boot (using </span><span class="nv">$INIT_SYSTEM</span><span class="s2">)?&quot;</span><span class="w"> </span>yes<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">START_AT_BOOT</span><span class="o">=</span>yes
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

configure_start_at_boot_if_desired<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">SANDSTORM_NEEDS_TO_BE_STARTED</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">  </span><span class="c1"># If the user doesn&#39;t want us to start Sandstorm at boot, then we</span>
<span class="w">  </span><span class="c1"># don&#39;t run anything in this function.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">START_AT_BOOT</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;systemd&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">INIT_SYSTEM</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>configure_systemd_init_system
<span class="w">    </span><span class="nv">SANDSTORM_NEEDS_TO_BE_STARTED</span><span class="o">=</span>no
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;sysvinit&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">INIT_SYSTEM</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>configure_sysvinit_init_system
<span class="w">    </span><span class="nv">SANDSTORM_NEEDS_TO_BE_STARTED</span><span class="o">=</span>no
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Note: I don&#39;t know how to set up sandstorm to auto-run at startup on&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  your system. :(&quot;</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

configure_systemd_init_system<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># WARNING: This function should only be run if we already know</span>
<span class="w">  </span><span class="c1"># systemd is the current init system. It relies on its caller to</span>
<span class="w">  </span><span class="c1"># verify that.</span>

<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">SYSTEMD_UNIT</span><span class="o">=</span><span class="s2">&quot;sandstorm.service&quot;</span>

<span class="w">  </span><span class="c1"># Stop Sandstorm if it is currently running.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>systemctl<span class="w"> </span>list-unit-files<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="nv">$SYSTEMD_UNIT</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>systemctl<span class="w"> </span>stop<span class="w"> </span>sandstorm<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># the init.d logic simply overwrites the init script if it exists, adopt that here</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>SYSTEMD_UNIT_PATH<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/systemd/system<span class="w"> </span>/run/systemd/system<span class="w"> </span>/usr/lib/systemd/system<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$SYSTEMD_UNIT_PATH</span>/<span class="nv">$SYSTEMD_UNIT</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>rm<span class="w"> </span><span class="nv">$SYSTEMD_UNIT_PATH</span>/<span class="nv">$SYSTEMD_UNIT</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>

<span class="w">  </span>cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/systemd/system/<span class="nv">$SYSTEMD_UNIT</span><span class="w"> </span><span class="s">&lt;&lt; __EOF__</span>
<span class="s">[Unit]</span>
<span class="s">Description=Sandstorm server</span>
<span class="s">After=local-fs.target remote-fs.target network-online.target</span>
<span class="s">Requires=local-fs.target remote-fs.target</span>
<span class="s">Wants=network-online.target</span>

<span class="s">[Service]</span>
<span class="s">Type=forking</span>
<span class="s">ExecStart=$PWD/sandstorm start</span>
<span class="s">ExecStop=$PWD/sandstorm stop</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">__EOF__</span>
<span class="w">  </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>sandstorm
<span class="w">  </span>systemctl<span class="w"> </span>start<span class="w"> </span>sandstorm
<span class="w">  </span><span class="nv">STARTED_SANDSTORM</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="o">}</span>

configure_sysvinit_init_system<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># WARNING: This function should only be run if we already know</span>
<span class="w">  </span><span class="c1"># sysvinit is the current init system. It relies on its caller to</span>
<span class="w">  </span><span class="c1"># verify that.</span>

<span class="w">  </span><span class="c1"># Stop Sandstorm, since we don&#39;t know what its configuration is.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/init.d/sandstorm<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>service<span class="w"> </span>sandstorm<span class="w"> </span>stop<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Replace the init script with something that should definitely</span>
<span class="w">  </span><span class="c1"># work.</span>

<span class="w">  </span>cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/init.d/sandstorm<span class="w"> </span><span class="s">&lt;&lt; __EOF__</span>
<span class="s">#! /bin/bash</span>
<span class="s">### BEGIN INIT INFO</span>
<span class="s"># Provides:          sandstorm</span>
<span class="s"># Required-Start:    \$local_fs \$remote_fs \$networking \$syslog</span>
<span class="s"># Required-Stop:     \$local_fs \$remote_fs \$networking \$syslog</span>
<span class="s"># Default-Start:     2 3 4 5</span>
<span class="s"># Default-Stop:      0 1 6</span>
<span class="s"># Short-Description: starts Sandstorm personal cloud server</span>
<span class="s">### END INIT INFO</span>

<span class="s">DESC=&quot;Sandstorm server&quot;</span>
<span class="s">DAEMON=$PWD/sandstorm</span>

<span class="s"># The Sandstorm runner supports all the common init commands directly.</span>
<span class="s"># We use -a to set the program name to make help text look nicer.</span>
<span class="s"># This requires bash, though.</span>
<span class="s">exec -a &quot;service sandstorm&quot; \$DAEMON &quot;\$@&quot;</span>
<span class="s">__EOF__</span>

<span class="w">  </span><span class="c1"># Mark as executable, and enable on boot.</span>
<span class="w">  </span>chmod<span class="w"> </span>+x<span class="w"> </span>/etc/init.d/sandstorm
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>which<span class="w"> </span>update-rc.d<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>update-rc.d<span class="w"> </span>sandstorm<span class="w"> </span>defaults
<span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>which<span class="w"> </span>rc-update<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>rc-update<span class="w"> </span>add<span class="w"> </span>sandstorm
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;WARNING: I couldn&#39;t figure out how to make the Sandstorm init script active on&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  your system; neither update-rc.d nor rc-update commands seem to exist. Sandstorm&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  will not start automatically at boot until you mark its init script active.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Start it right now.</span>
<span class="w">  </span>service<span class="w"> </span>sandstorm<span class="w"> </span>start
<span class="w">  </span><span class="nv">STARTED_SANDSTORM</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="o">}</span>

generate_admin_token<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If dev accounts are enabled, the user does not need an admin token.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Allow the person running the install.sh script to pre-generate an admin token, specified as an</span>
<span class="w">  </span><span class="c1"># environment variable, so that they can ignore the output text of install.sh.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ADMIN_TOKEN</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">TMPFILENAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>mktemp<span class="w"> </span>./var/sandstorm/adminTokenTmp.XXXXXXXXXX<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMPFILENAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;./var/sandstorm/adminToken&quot;</span>
<span class="w">    </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMPFILENAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="w">    </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="w">    </span>chgrp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">ADMIN_TOKEN</span><span class="o">=</span><span class="k">$(</span>./sandstorm<span class="w"> </span>admin-token<span class="w"> </span>--quiet<span class="k">)</span>
<span class="o">}</span>

print_success<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SANDSTORM_NEEDS_TO_BE_STARTED</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Installation complete. To start your server now, run:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  </span><span class="nv">$DIR</span><span class="s2">/sandstorm start&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Once that&#39;s done, visit this link to start using it:&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;Your server is now online! &quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Visit this link to start using it:&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">  </span><span class="c1"># If there is an admin token at this point, print an admin token URL.  Otherwise, don&#39;t. Note that</span>
<span class="w">  </span><span class="c1"># when dev accounts are enabled, it is advantageous to not print an admin token URL.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ADMIN_TOKEN</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  </span><span class="si">${</span><span class="nv">BASE_URL</span><span class="k">:-</span><span class="p">(unknown; bad config)</span><span class="si">}</span><span class="s2">/setup/token/</span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: This URL expires in 15 minutes. You can generate a new setup URL by running&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&#39;sudo sandstorm admin-token&#39; from the command line.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  </span><span class="si">${</span><span class="nv">BASE_URL</span><span class="k">:-</span><span class="p">(unknown; bad config)</span><span class="si">}</span><span class="s2">/&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ALLOW_DEV_ACCOUNTS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">   </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">   </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NOTE: Use the passwordless admin account called Alice for convenient dev login (since you have &#39;dev </span>
<span class="s2">accounts&#39; enabled).&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="w">  </span><span class="nb">echo</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;To learn how to control the server, run:&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  sandstorm help&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  </span><span class="nv">$DIR</span><span class="s2">/sandstorm help&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

sandcats_provide_help<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Sandcats.io is a free dynamic DNS service run by the Sandstorm development team.&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You can:&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Read more about it at:&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  https://docs.sandstorm.io/en/latest/administering/sandcats/&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Recover access to a domain you once registered with sandcats&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;* Just press enter to go to the previous question.&quot;</span>
<span class="w">  </span>sandcats_recover_domain
<span class="o">}</span>

sandcats_recover_domain<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;What Sandcats subdomain do you want to recover?&quot;</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="c1"># If the user wants none of our help, then go back to registration.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>DESIRED_SANDCATS_NAME
<span class="w">    </span>sandcats_register_name
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If the user gave us a hostname that contains a dot, tell them they need to re-enter it.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You entered: </span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;but this function just wants the name of your subdomain, not including any dot characters.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Please try again.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span>sandcats_recover_domain
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;OK. We will send a recovery token to the email address on file. Type no to abort.&quot;</span>
<span class="w">  </span><span class="nv">OK_TO_CONTINUE</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;OK to continue?&quot;</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="k">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OK_TO_CONTINUE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>DESIRED_SANDCATS_NAME
<span class="w">    </span>sandcats_register_name
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># First, we attempt to send the user a domain recovery token.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandcats/sendrecoverytoken-log&quot;</span>
<span class="w">  </span>touch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">    </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$SANDCATS_CURL_PARAMS</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;rawHostname=</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s1">&#39;X-Sand: cats&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s2">&quot;Accept: text/plain&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_API_BASE</span><span class="si">}</span><span class="s2">/sendrecoverytoken&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$LOG_PATH</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span>sandcats_recover_domain
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Show the server&#39;s output, which presumably is some happy</span>
<span class="w">  </span><span class="c1"># message.</span>
<span class="w">  </span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="c1"># Make sure that is on a line of its own.</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">  </span><span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Please enter the token that we sent to you by email.&quot;</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="k">)</span>

<span class="w">  </span><span class="c1"># If the token is empty, then they just hit enter; take them to the start of help.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;Empty tokens are not valid.&quot;</span>
<span class="w">    </span>sandcats_recover_domain
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Let&#39;s submit that token to the server&#39;s &quot;recover&quot; endpoint.</span>
<span class="w">  </span><span class="c1">#</span>
<span class="w">  </span><span class="c1"># This action registers the new key as the authoritative key for</span>
<span class="w">  </span><span class="c1"># this hostname. It also sends an email to the user telling them</span>
<span class="w">  </span><span class="c1"># that we changed the key they have on file.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandcats/recover-log&quot;</span>
<span class="w">  </span>touch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">      </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$SANDCATS_CURL_PARAMS</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;rawHostname=</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;recoveryToken=</span><span class="nv">$TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s1">&#39;X-Sand: cats&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s2">&quot;Accept: text/plain&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--cert<span class="w"> </span>var/sandcats/id_rsa.private_combined<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_API_BASE</span><span class="si">}</span><span class="s2">/recover&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$LOG_PATH</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span>sandcats_recover_domain
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Show the server&#39;s output, which presumably is some happy</span>
<span class="w">  </span><span class="c1"># message.</span>
<span class="w">  </span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="c1"># Make sure that is on a line of its own.</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>

<span class="w">  </span><span class="c1"># Now we can do a call to /update, which we will do silently on the</span>
<span class="w">  </span><span class="c1"># user&#39;s behalf. This uses the new key we registered (via /recover)</span>
<span class="w">  </span><span class="c1"># and sets the IP address for this host in the sandcats.io DNS</span>
<span class="w">  </span><span class="c1"># service.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandcats/update-log&quot;</span>
<span class="w">  </span>touch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">    </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$SANDCATS_CURL_PARAMS</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;rawHostname=</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s1">&#39;X-Sand: cats&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s2">&quot;Accept: text/plain&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--cert<span class="w"> </span>var/sandcats/id_rsa.private_combined<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_API_BASE</span><span class="si">}</span><span class="s2">/update&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$LOG_PATH</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span>sandcats_recover_domain
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Show the server&#39;s happy message.</span>
<span class="w">  </span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="c1"># Make sure that is on a line of its own.</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>

<span class="w">  </span><span class="nv">SANDCATS_SUCCESSFUL</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="nv">USE_HTTPS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Congratulations! You&#39;re all configured to use </span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Your credentials to use it are in </span><span class="k">$(</span>readlink<span class="w"> </span>-f<span class="w"> </span>var/sandcats<span class="k">)</span><span class="s2">; consider making a backup.&quot;</span>
<span class="o">}</span>

sandcats_registerreserved<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Registering your pre-reserved domain.&quot;</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span>LOG_PATH
<span class="w">  </span><span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandcats/registerreserved-log&quot;</span>
<span class="w">  </span>touch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">    </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$SANDCATS_CURL_PARAMS</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;domainReservationToken=</span><span class="nv">$SANDCATS_DOMAIN_RESERVATION_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;rawHostname=</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s1">&#39;X-Sand: cats&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s2">&quot;Accept: text/plain&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--cert<span class="w"> </span>var/sandcats/id_rsa.private_combined<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_API_BASE</span><span class="si">}</span><span class="s2">/registerreserved&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">  </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Show the server&#39;s output, which presumably is some happy</span>
<span class="w">    </span><span class="c1"># message.</span>
<span class="w">    </span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Make sure that is on a line of its own.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="c1"># Set these global variables to inform the installer down the</span>
<span class="w">    </span><span class="c1"># road.</span>
<span class="w">    </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">USE_HTTPS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">SANDCATS_SUCCESSFUL</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Congratulations! We have registered your </span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2"> name.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Your credentials to use it are in </span><span class="k">$(</span>readlink<span class="w"> </span>-f<span class="w"> </span>var/sandcats<span class="k">)</span><span class="s2">; consider making a backup.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="c1"># Show the server&#39;s output, and bail out.</span>
<span class="w">    </span><span class="c1">#</span>
<span class="w">    </span><span class="c1"># TODO(soon): Wait 1 minute in case the sandcats.io service had a brief hiccup, and retry (let&#39;s</span>
<span class="w">    </span><span class="c1"># say) 5 times.</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_SANDCATS_REGISTER_RESERVED_SRV_FAIL&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

sandcats_register_name<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># We allow environment variables to override some details of the</span>
<span class="w">  </span><span class="c1"># Sandcats service, so that during development, we can test against</span>
<span class="w">  </span><span class="c1"># a non-production Sandcats service.</span>
<span class="w">  </span><span class="nv">SANDCATS_API_BASE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_API_BASE</span><span class="k">:-</span><span class="nv">https</span><span class="p">://sandcats.io</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">SANDCATS_CURL_PARAMS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OVERRIDE_SANDCATS_CURL_PARAMS</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="c1"># If there is a SANDCATS_DOMAIN_RESERVATION_TOKEN provided, then we call a different function to</span>
<span class="w">  </span><span class="c1"># do the work.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_DOMAIN_RESERVATION_TOKEN</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>sandcats_registerreserved
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Choose your desired Sandcats subdomain (alphanumeric, max 20 characters).&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Type the word none to skip this step, or help for help.&quot;</span>
<span class="w">    </span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;What *.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2"> subdomain would you like?&quot;</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="k">)</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If they just press enter, insist that they type either the word</span>
<span class="w">  </span><span class="c1"># &quot;none&quot; or provide a name they want to register.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>sandcats_register_name
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If the user really wants none of our sandcats help, then bail out.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># If the user wants help, offer help.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>sandcats_provide_help
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Validate the client-side, to avoid problems, against a slightly</span>
<span class="w">  </span><span class="c1"># less rigorous regex than the server is using.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span><span class="m">0</span>-9a-zA-Z-<span class="o">]{</span><span class="m">1</span>,20<span class="o">}</span>$<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>DESIRED_SANDCATS_NAME
<span class="w">    </span>sandcats_register_name
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># Ask them for their email address, since we use that as part of Sandcats</span>
<span class="w">  </span><span class="c1"># registration.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;We need your email on file so we can help you recover your domain if you lose access. No spam.&quot;</span>
<span class="w">    </span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Enter your email address:&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="c1"># If the user fails to enter an email address, bail out.</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SANDCATS_REGISTRATION_EMAIL</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;For the DNS service, we really do need an email address. To cancel, type: Ctrl-C.&quot;</span>
<span class="w">      </span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="o">=</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Enter your email address:&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Registering your domain.&quot;</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span>LOG_PATH
<span class="w">  </span><span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;var/sandcats/register-log&quot;</span>
<span class="w">  </span>touch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">HTTP_STATUS</span><span class="o">=</span><span class="k">$(</span>
<span class="w">    </span>dotdotdot_curl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--silent<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--max-time<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$SANDCATS_CURL_PARAMS</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURL_USER_AGENT</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;rawHostname=</span><span class="nv">$DESIRED_SANDCATS_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;email=</span><span class="nv">$SANDCATS_REGISTRATION_EMAIL</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-w<span class="w"> </span><span class="s1">&#39;%{http_code}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s1">&#39;X-Sand: cats&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-H<span class="w"> </span><span class="s2">&quot;Accept: text/plain&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--cert<span class="w"> </span>var/sandcats/id_rsa.private_combined<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_API_BASE</span><span class="si">}</span><span class="s2">/register&quot;</span><span class="k">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;200&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HTTP_STATUS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">  </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Show the server&#39;s output, which presumably is some happy</span>
<span class="w">    </span><span class="c1"># message.</span>
<span class="w">    </span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Make sure that is on a line of its own.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="c1"># Set these global variables to inform the installer down the</span>
<span class="w">    </span><span class="c1"># road.</span>
<span class="w">    </span><span class="nv">SS_HOSTNAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">USE_EXTERNAL_INTERFACE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">USE_HTTPS</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nv">SANDCATS_SUCCESSFUL</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Congratulations! We have registered your </span><span class="si">${</span><span class="nv">DESIRED_SANDCATS_NAME</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">SANDCATS_BASE_DOMAIN</span><span class="si">}</span><span class="s2"> name.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Your credentials to use it are in </span><span class="k">$(</span>readlink<span class="w"> </span>-f<span class="w"> </span>var/sandcats<span class="k">)</span><span class="s2">; consider making a backup.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="c1"># Show the server&#39;s output, and re-run this function.</span>
<span class="w">    </span>error<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_PATH</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>DESIRED_SANDCATS_NAME
<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>SANDCATS_REGISTRATION_EMAIL
<span class="w">    </span>sandcats_register_name
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

wait_for_server_bind_to_its_port<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="c1"># If we haven&#39;t started Sandstorm ourselves, it&#39;s not sensible to expect it to be listening.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">STARTED_SANDSTORM</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="c1"># For sandcats HTTPS, we have to generate the initial non-SNI key before Sandstorm binds to port</span>
<span class="w">  </span><span class="c1"># 443. So we let the user know it could be slow. For all users, using the admin token requires</span>
<span class="w">  </span><span class="c1"># that the server has started.</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">PORT_TO_CHECK</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HTTPS_PORT</span><span class="k">:-</span><span class="nv">$PORT</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;Your server is coming online. Waiting up to 90 seconds...&quot;</span>
<span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">ONLINE_YET</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>waited_n_seconds<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">89</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>is_port_bound<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BIND_IP</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PORT_TO_CHECK</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">ONLINE_YET</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ONLINE_YET</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;.&quot;</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">done</span>

<span class="w">  </span><span class="c1"># One last check before we bail out.</span>
<span class="w">  </span>is_port_bound<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BIND_IP</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PORT_TO_CHECK</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">ONLINE_YET</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ONLINE_YET</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span>fail<span class="w"> </span><span class="s2">&quot;E_NEVER_LISTENED&quot;</span><span class="w"> </span><span class="s2">&quot;Your server never started listening.&quot;</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

sandcats_generate_keys<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># The Sandcats service places its authentication files in $DIR/var/sandcats.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>var/sandcats/id_rsa.private_combined<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># The openssl key generation process can take a few seconds, so we</span>
<span class="w">    </span><span class="c1"># print a ... while that happens.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;...&#39;</span>

<span class="w">    </span><span class="c1"># We are already in $DIR. It&#39;s important to make it mode 0700</span>
<span class="w">    </span><span class="c1"># because we store TLS client authentication keys here.</span>
<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>var/sandcats
<span class="w">    </span>chmod<span class="w"> </span><span class="m">0700</span><span class="w"> </span>var/sandcats

<span class="w">    </span><span class="c1"># If we are root, we must chown the Sandcats configuration</span>
<span class="w">    </span><span class="c1"># directory to the user that will be running Sandstorm.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>chown<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span>var/sandcats
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Generate key for client certificate. OpenSSL will read from</span>
<span class="w">    </span><span class="c1"># /dev/urandom by default, so this won&#39;t block. We abuse the ``</span>
<span class="w">    </span><span class="c1"># operator so we can have inline comments in a multi-line command.</span>
<span class="w">    </span>openssl<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>req<span class="w"> </span><span class="sb">`</span><span class="c1"># Invoke OpenSSL&#39;s PKCS#10 X.509 bits.` \</span>
<span class="w">        </span>-new<span class="w"> </span><span class="sb">`</span><span class="c1"># Create a new certificate/request.` \</span>
<span class="w">        </span>-newkey<span class="w"> </span>rsa:4096<span class="w"> </span><span class="sb">`</span><span class="c1"># Create a new RSA key of length 4096 bits.` \</span>
<span class="w">        </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span><span class="sb">`</span><span class="c1"># Make the self-signed cert valid for 10 years.` \</span>
<span class="w">        </span>-nodes<span class="w"> </span><span class="sb">`</span><span class="c1"># no DES -- that is, do not encrypt the key at rest.` \</span>
<span class="w">        </span>-x509<span class="w"> </span><span class="sb">`</span><span class="c1"># Output a certificate, rather than a signing request.` \</span>
<span class="w">        </span><span class="sb">`</span><span class="c1"># Sandcats ignores the subject in the certificate; use` \</span>
<span class="w">        </span><span class="sb">`</span><span class="c1"># OpenSSL defaults.` \</span>
<span class="w">        </span>-subj<span class="w"> </span><span class="s2">&quot;/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-keyout<span class="w"> </span>var/sandcats/id_rsa<span class="w"> </span><span class="sb">`</span><span class="c1"># Store the resulting RSA private key in id_rsa` \</span>
<span class="w">        </span>-out<span class="w"> </span>var/sandcats/id_rsa.pub<span class="w"> </span><span class="sb">`</span><span class="c1"># Store the resulting certificate in id_rsa.pub` \</span>
<span class="w">        </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="sb">`</span><span class="c1"># Silence the progress output.`</span>

<span class="w">    </span><span class="c1"># We combine these two things into one glorious all-inclusive file</span>
<span class="w">    </span><span class="c1"># for the `curl` command. It is just as private as id_rsa.</span>
<span class="w">    </span>cat<span class="w"> </span>var/sandcats/id_rsa<span class="w"> </span>var/sandcats/id_rsa.pub<span class="w"> </span>&gt;<span class="w"> </span>var/sandcats/id_rsa.private_combined

<span class="w">    </span><span class="c1"># Set filesystem permissions, in case the files get copied</span>
<span class="w">    </span><span class="c1"># into the wrong place later.</span>
<span class="w">    </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span>var/sandcats/id_rsa<span class="w"> </span>var/sandcats/id_rsa.pub<span class="w"> </span>var/sandcats/id_rsa.private_combined

<span class="w">    </span><span class="c1"># If we are root, make sure the files are owned by the</span>
<span class="w">    </span><span class="c1"># $SERVER_USER. This way, Sandstorm can actually read them.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENTLY_UID_ZERO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>chown<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$SERVER_USER</span><span class="s2">&quot;</span><span class="w"> </span>var/sandcats/id_rsa<span class="o">{</span>,.pub,.private_combined<span class="o">}</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Go to the start of the line, before the &quot;...&quot; that we</span>
<span class="w">    </span><span class="c1"># left on the screen, allowing future echo statements to</span>
<span class="w">    </span><span class="c1"># overwrite it.</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;\r&#39;</span>
<span class="o">}</span>

configure_https<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USE_HTTPS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nb">echo</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Now we&#39;re going to fetch a TLS certificate using Let&#39;s Encrypt. This is a free&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;service provided by the nonprofit Electronic Frontier Foundation. By using this&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;service, you agree to be bound by the subscriber agreement, found here:&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  https://letsencrypt.org/repository/#let-s-encrypt-subscriber-agreement&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;If you do not agree, please press ctrl+C now to cancel installation.&quot;</span>
<span class="w">  </span><span class="nb">echo</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACME_EMAIL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;You must provide an email address, which will be shared with Let&#39;s Encrypt.&quot;</span>
<span class="w">    </span><span class="nv">ACME_EMAIL</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>prompt<span class="w"> </span><span class="s2">&quot;Your email address for Let&#39;s Encrypt:&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SANDCATS_REGISTRATION_EMAIL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">$DIR</span>/sandstorm<span class="w"> </span>create-acme-account<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ACME_EMAIL</span><span class="s2">&quot;</span><span class="w"> </span>--accept-terms<span class="w"> </span><span class="o">||</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_CREATE_ACME_ACCOUNT&quot;</span><span class="w"> </span><span class="s2">&quot;Failed to create Let&#39;s Encrypt account.&quot;</span>

<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Your Let&#39;s Encrypt account has been created. Now we&#39;ll fetch a certificate!&quot;</span>
<span class="w">  </span><span class="nv">$DIR</span>/sandstorm<span class="w"> </span>renew-certificate<span class="w"> </span><span class="o">||</span>
<span class="w">      </span>fail<span class="w"> </span><span class="s2">&quot;E_FETCH_CERTIFICATE&quot;</span><span class="w"> </span><span class="s2">&quot;Failed to fetch certificate.&quot;</span>
<span class="o">}</span>

<span class="c1"># Now that the steps exist as functions, run them in an order that</span>
<span class="c1"># would result in a working install.</span>
handle_args<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
set_umask
assert_on_terminal
assert_linux_x86_64
assert_usable_kernel
detect_current_uid
assert_dependencies
assert_valid_bundle_file
detect_init_system
choose_install_mode
maybe_enable_userns_sysctl
choose_external_or_internal
choose_install_dir
choose_smtp_port
load_existing_settings
choose_server_user_if_needed
create_server_user_if_needed
configure_auto_updates
configure_dev_accounts
configure_hostnames
save_config
download_latest_bundle_and_extract_if_needed
extract_bundle_if_provided
make_runtime_directories
generate_admin_token
set_permissions
install_sandstorm_symlinks
ask_about_starting_at_boot
configure_start_at_boot_if_desired
wait_for_server_bind_to_its_port
configure_https
print_success
<span class="o">}</span>

<span class="c1"># Now that we know the whole script has downloaded, run it.</span>
_<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2025 Mkdox curlpipebash &bull; pforret
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "header.autohide", "navigation.instant", "navigation.integrate", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "search.highlight", "search.suggest", "toc.integrate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>